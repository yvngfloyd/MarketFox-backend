import os
import logging
from typing import Any, Dict

from fastapi import FastAPI, Body
from fastapi.middleware.cors import CORSMiddleware
from openai import OpenAI
import uvicorn

# ----------------- Ð›Ð¾Ð³Ð³ÐµÑ€ -----------------

logger = logging.getLogger("marketfox")
logger.setLevel(logging.INFO)
handler = logging.StreamHandler()
handler.setFormatter(
    logging.Formatter("[%(asctime)s] [%(levelname)s] %(name)s: %(message)s")
)
logger.addHandler(handler)

# ----------------- FastAPI -----------------

app = FastAPI(
    title="MarketFox API (Groq, Railway)",
    description="Backend Ð´Ð»Ñ Ð°ÑÑÐ¸ÑÑ‚ÐµÐ½Ñ‚Ð° Ð¿Ð¾ Ð¿Ð¾Ð´Ð±Ð¾Ñ€Ñƒ Ñ‚Ð¾Ð²Ð°Ñ€Ð¾Ð²",
    version="0.5.0",
)

app.add_middleware(
    CORSMiddleware,
    allow_origins=["*"],
    allow_methods=["*"],
    allow_headers=["*"],
)

# ----------------- PROMPTS -----------------

# ÐŸÑ€Ð¾Ð¼Ñ‚ Ð´Ð»Ñ Ð¿Ð¾Ð´Ð±Ð¾Ñ€Ð° Ñ‚Ð¾Ð²Ð°Ñ€Ð° â€” ÐÐžÐ’Ð«Ð™, Ð±ÐµÐ· Ð½Ð°Ð²ÑÐ·Ñ‡Ð¸Ð²Ñ‹Ñ… ÑƒÑ‚Ð¾Ñ‡Ð½ÑÐ»Ð¾Ðº.
SYSTEM_PROMPT_PRODUCT = """
Ð¢Ñ‹ Ð¿Ð¾Ð¼Ð¾Ñ‰Ð½Ð¸Ðº Ð¿Ð¾ Ð²Ñ‹Ð±Ð¾Ñ€Ñƒ Ñ‚Ð¾Ð²Ð°Ñ€Ð¾Ð² Ð½Ð° Ð¼Ð°Ñ€ÐºÐµÑ‚Ð¿Ð»ÐµÐ¹ÑÐµ. ÐžÑ‚Ð²ÐµÑ‡Ð°ÐµÑˆÑŒ Ð¿Ð¾-Ñ€ÑƒÑÑÐºÐ¸, ÐºÐ¾Ñ€Ð¾Ñ‚ÐºÐ¾ Ð¸ Ð¿Ð¾ Ð´ÐµÐ»Ñƒ.

Ð¢ÐµÐ±Ðµ Ð¿Ñ€Ð¸Ñ…Ð¾Ð´Ð¸Ñ‚ ÐžÐ”ÐÐ Ñ„Ñ€Ð°Ð·Ð° Ð¾Ñ‚ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ. Ð¡Ñ‡Ð¸Ñ‚Ð°Ð¹, Ñ‡Ñ‚Ð¾ ÑÑ‚Ð¾ ÑƒÐ¶Ðµ Ð³Ð¾Ñ‚Ð¾Ð²Ñ‹Ð¹ Ð·Ð°Ð¿Ñ€Ð¾Ñ.

ÐŸÑ€Ð°Ð²Ð¸Ð»Ð°:

1. Ð•ÑÐ»Ð¸ Ð² Ð·Ð°Ð¿Ñ€Ð¾ÑÐµ ÑƒÐ¿Ð¾Ð¼ÑÐ½ÑƒÑ‚ Ñ‚Ð¸Ð¿ Ñ‚Ð¾Ð²Ð°Ñ€Ð° (ÑÐ¼Ð°Ñ€Ñ‚Ñ„Ð¾Ð½, Ð¼Ð¾Ð»Ð¾Ñ‚Ð¾Ðº, Ð½Ð°ÑƒÑˆÐ½Ð¸ÐºÐ¸, Ñ„ÐµÐ½ Ð¸ Ñ‚.Ð¿.)
   Ð˜ ÐµÑÑ‚ÑŒ Ñ…Ð¾Ñ‚Ñ Ð±Ñ‹ Ð¿Ñ€Ð¸Ð¼ÐµÑ€Ð½Ñ‹Ð¹ Ð±ÑŽÐ´Ð¶ÐµÑ‚ (Ñ†Ð¸Ñ„Ñ€Ñ‹: "Ð´Ð¾ 3000", "Ð² Ñ€Ð°Ð¹Ð¾Ð½Ðµ 5Ðº" Ð¸ Ñ‚.Ð´.),
   Ð¡Ð ÐÐ—Ð£ Ð´Ð°Ð²Ð°Ð¹ Ñ€ÐµÐºÐ¾Ð¼ÐµÐ½Ð´Ð°Ñ†Ð¸Ð¸, ÐÐ• Ð·Ð°Ð´Ð°Ð²Ð°Ñ Ð´Ð¾Ð¿Ð¾Ð»Ð½Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ñ… Ð²Ð¾Ð¿Ñ€Ð¾ÑÐ¾Ð².

2. Ð”Ð°Ð¹ 3â€“5 ÐºÐ¾Ð½ÐºÑ€ÐµÑ‚Ð½Ñ‹Ñ… ÑÐ¾Ð²ÐµÑ‚Ð¾Ð² Ð² Ð²Ð¸Ð´Ðµ ÑÐ¿Ð¸ÑÐºÐ° Ñ Ð¼Ð°Ñ€ÐºÐµÑ€Ð°Ð¼Ð¸:
   - Ð½Ð° ÐºÐ°ÐºÐ¸Ðµ Ñ…Ð°Ñ€Ð°ÐºÑ‚ÐµÑ€Ð¸ÑÑ‚Ð¸ÐºÐ¸ ÑÐ¼Ð¾Ñ‚Ñ€ÐµÑ‚ÑŒ;
   - ÐºÐ°ÐºÐ¸Ðµ Ð²Ð°Ñ€Ð¸Ð°Ð½Ñ‚Ñ‹ Ð¿Ð¾Ð´Ð¾Ð¹Ð´ÑƒÑ‚ Ð¿Ð¾Ð´ Ð·Ð°Ð¿Ñ€Ð¾Ñ;
   - ÐºÐ°ÐºÐ¸Ñ… Ð¾ÑˆÐ¸Ð±Ð¾Ðº Ð»ÑƒÑ‡ÑˆÐµ Ð¸Ð·Ð±ÐµÐ¶Ð°Ñ‚ÑŒ.

3. ÐŸÐ¸ÑˆÐ¸ Ð¶Ð¸Ð²Ñ‹Ð¼, Ð¿Ñ€Ð¾ÑÑ‚Ñ‹Ð¼ ÑÐ·Ñ‹ÐºÐ¾Ð¼. Ð‘ÐµÐ· Ð²Ð¾Ð´Ñ‹, Ð¼Ð°ÐºÑÐ¸Ð¼ÑƒÐ¼ 6â€“8 Ð¿Ñ€ÐµÐ´Ð»Ð¾Ð¶ÐµÐ½Ð¸Ð¹.

4. Ð•ÑÐ»Ð¸ Ð·Ð°Ð¿Ñ€Ð¾Ñ ÑÐ¾Ð²ÑÐµÐ¼ Ð°Ð±ÑÑ‚Ñ€Ð°ÐºÑ‚Ð½Ñ‹Ð¹ (Ð½Ð°Ð¿Ñ€Ð¸Ð¼ÐµÑ€: "Ñ‡Ñ‚Ð¾ ÐºÑƒÐ¿Ð¸Ñ‚ÑŒ", "Ð¿Ð¾Ð´ÑÐºÐ°Ð¶Ð¸ Ð¿Ð¾Ð´Ð°Ñ€Ð¾Ðº"),
   Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ñ‚Ð¾Ð³Ð´Ð° Ð·Ð°Ð´Ð°Ð¹ 2â€“3 ÐºÐ¾Ñ€Ð¾Ñ‚ÐºÐ¸Ñ… ÑƒÑ‚Ð¾Ñ‡Ð½ÑÑŽÑ‰Ð¸Ñ… Ð²Ð¾Ð¿Ñ€Ð¾ÑÐ° Ð² ÐžÐ”ÐÐžÐœ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ð¸.

5. ÐÐ¸ÐºÐ¾Ð³Ð´Ð° Ð½Ðµ Ð³Ð¾Ð²Ð¾Ñ€Ð¸, Ñ‡Ñ‚Ð¾ Ñ‚Ñ‹ Ð˜Ð˜ Ð¸Ð»Ð¸ Ð¼Ð¾Ð´ÐµÐ»ÑŒ. ÐŸÑ€Ð¾ÑÑ‚Ð¾ Ð¾Ð±Ñ‰Ð°Ð¹ÑÑ ÐºÐ°Ðº Ð½Ð¾Ñ€Ð¼Ð°Ð»ÑŒÐ½Ñ‹Ð¹ ÐºÐ¾Ð½ÑÑƒÐ»ÑŒÑ‚Ð°Ð½Ñ‚.
"""

# ÐÐ° Ð±ÑƒÐ´ÑƒÑ‰ÐµÐµ Ð¼Ð¾Ð¶Ð½Ð¾ Ð·Ð°Ð²ÐµÑÑ‚Ð¸ Ð¾Ñ‚Ð´ÐµÐ»ÑŒÐ½Ñ‹Ðµ Ð¿Ñ€Ð¾Ð¼Ñ‚Ñ‹ Ð´Ð»Ñ Ð¿Ð¾Ð´Ð°Ñ€ÐºÐ¾Ð², ÑÑ€Ð°Ð²Ð½ÐµÐ½Ð¸Ñ Ð¸ Ñ‚.Ð¿.
SYSTEM_PROMPT_GENERIC = """
Ð¢Ñ‹ Ð´Ñ€ÑƒÐ¶ÐµÐ»ÑŽÐ±Ð½Ñ‹Ð¹ ÐºÐ¾Ð½ÑÑƒÐ»ÑŒÑ‚Ð°Ð½Ñ‚ Ð¿Ð¾ Ñ‚Ð¾Ð²Ð°Ñ€Ð°Ð¼. ÐžÑ‚Ð²ÐµÑ‡Ð°Ð¹ Ð¿Ð¾-Ñ€ÑƒÑÑÐºÐ¸, Ð¿Ð¾Ð½ÑÑ‚Ð½Ð¾ Ð¸ Ð¿Ð¾ Ð´ÐµÐ»Ñƒ.
Ð”Ð°Ð¹ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŽ Ð¿Ñ€Ð°ÐºÑ‚Ð¸Ñ‡Ð½Ñ‹Ðµ ÑÐ¾Ð²ÐµÑ‚Ñ‹ Ð¿Ð¾ ÐµÐ³Ð¾ Ð·Ð°Ð¿Ñ€Ð¾ÑÑƒ.
"""

# ----------------- GROQ CLIENT -----------------


def get_groq_client() -> OpenAI:
    """
    ÐšÐ»Ð¸ÐµÐ½Ñ‚ Ð´Ð»Ñ Groq Ñ‡ÐµÑ€ÐµÐ· Ð±Ð¸Ð±Ð»Ð¸Ð¾Ñ‚ÐµÐºÑƒ openai.

    ÐÑƒÐ¶Ð½Ð° Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ð°Ñ Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ñ:
    GROQ_API_KEY=...
    """
    api_key = os.environ.get("GROQ_API_KEY")
    if not api_key:
        raise RuntimeError("GROQ_API_KEY is not set")

    # Groq Ñ€Ð°Ð±Ð¾Ñ‚Ð°ÐµÑ‚ Ñ‡ÐµÑ€ÐµÐ· ÑÐ¾Ð²Ð¼ÐµÑÑ‚Ð¸Ð¼Ñ‹Ð¹ openai endpoint
    client = OpenAI(
        api_key=api_key,
        base_url="https://api.groq.com/openai/v1",
    )
    return client


async def call_groq(system_prompt: str, user_query: str) -> str:
    """Ð’Ñ‹Ð·Ð¾Ð² Groq, Ð²Ð¾Ð·Ð²Ñ€Ð°Ñ‰Ð°ÐµÐ¼ Ñ‚ÐµÐºÑÑ‚ Ð¾Ñ‚Ð²ÐµÑ‚Ð°."""
    client = get_groq_client()

    response = client.chat.completions.create(
        model="llama-3.1-8b-instant",
        messages=[
            {"role": "system", "content": system_prompt},
            {"role": "user", "content": user_query},
        ],
        temperature=0.7,
        max_tokens=600,
    )

    return (response.choices[0].message.content or "").strip()


# ----------------- Ð‘Ð˜Ð—ÐÐ•Ð¡-Ð›ÐžÐ“Ð˜ÐšÐ -----------------


async def generate_reply(scenario: str, query: str) -> str:
    """
    Ð¡Ñ‚Ñ€Ð¾Ð¸Ð¼ Ñ‚ÐµÐºÑÑ‚ Ð¾Ñ‚Ð²ÐµÑ‚Ð° Ð´Ð»Ñ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ Ð² Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸ Ð¾Ñ‚ ÑÑ†ÐµÐ½Ð°Ñ€Ð¸Ñ.

    Ð¡ÐµÐ¹Ñ‡Ð°Ñ Ð¿Ð¾ Ñ„Ð°ÐºÑ‚Ñƒ Ð¾ÑÐ½Ð¾Ð²Ð½Ð¾Ðµ â€” product_pick.
    """
    try:
        if scenario == "product_pick":
            system_prompt = SYSTEM_PROMPT_PRODUCT
        else:
            system_prompt = SYSTEM_PROMPT_GENERIC

        text = await call_groq(system_prompt, query)
        if not text:
            raise ValueError("Empty reply from Groq")

        return text

    except Exception as e:
        # Ð›Ð¾Ð³Ð¸Ñ€ÑƒÐµÐ¼, Ð½Ð¾ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŽ Ð´Ð°Ñ‘Ð¼ Ñ‡ÐµÐ»Ð¾Ð²ÐµÐºÐ¾-Ñ‡Ð¸Ñ‚Ð°Ð±ÐµÐ»ÑŒÐ½Ñ‹Ð¹ Ñ„Ð¾Ð»Ð±ÑÐº
        logger.error("Groq API error: %s", e, exc_info=True)

        return (
            "Ð¡ÐµÐ¹Ñ‡Ð°Ñ Ñ Ð½Ðµ Ð¼Ð¾Ð³Ñƒ Ð¾Ð±Ñ€Ð°Ñ‚Ð¸Ñ‚ÑŒÑÑ Ðº Ð½ÐµÐ¹Ñ€Ð¾ÑÐµÑ‚Ð¸, Ð½Ð¾ Ð²Ð¾Ñ‚ Ð±Ð°Ð·Ð¾Ð²Ñ‹Ð¹ Ð°Ð»Ð³Ð¾Ñ€Ð¸Ñ‚Ð¼ Ð²Ñ‹Ð±Ð¾Ñ€Ð°:\n\n"
            "1) ÐžÐ¿Ñ€ÐµÐ´ÐµÐ»Ð¸ Ð±ÑŽÐ´Ð¶ÐµÑ‚ Ð¸ 1â€“2 Ð³Ð»Ð°Ð²Ð½Ñ‹Ðµ Ñ…Ð°Ñ€Ð°ÐºÑ‚ÐµÑ€Ð¸ÑÑ‚Ð¸ÐºÐ¸ Ñ‚Ð¾Ð²Ð°Ñ€Ð°.\n"
            "2) ÐžÑ‚ÑÐµÐ¹ Ð²Ð°Ñ€Ð¸Ð°Ð½Ñ‚Ñ‹ Ð±ÐµÐ· Ð¾Ñ‚Ð·Ñ‹Ð²Ð¾Ð² Ð¸ Ñ Ð¾Ñ‡ÐµÐ½ÑŒ Ð½Ð¸Ð·ÐºÐ¸Ð¼ Ñ€ÐµÐ¹Ñ‚Ð¸Ð½Ð³Ð¾Ð¼.\n"
            "3) Ð¡Ñ€Ð°Ð²Ð½Ð¸ 3â€“5 Ð°Ð´ÐµÐºÐ²Ð°Ñ‚Ð½Ñ‹Ñ… Ð¼Ð¾Ð´ÐµÐ»ÐµÐ¹ Ð¿Ð¾ ÐºÐ»ÑŽÑ‡ÐµÐ²Ñ‹Ð¼ Ð¿Ð°Ñ€Ð°Ð¼ÐµÑ‚Ñ€Ð°Ð¼.\n"
            "4) ÐŸÐ¾Ñ‡Ð¸Ñ‚Ð°Ð¹ Ð½ÐµÐ³Ð°Ñ‚Ð¸Ð²Ð½Ñ‹Ðµ Ð¾Ñ‚Ð·Ñ‹Ð²Ñ‹ â€” Ð¾Ð½Ð¸ Ð»ÑƒÑ‡ÑˆÐµ Ð²ÑÐµÐ³Ð¾ Ð¿Ð¾ÐºÐ°Ð·Ñ‹Ð²Ð°ÑŽÑ‚ Ñ€ÐµÐ°Ð»ÑŒÐ½Ñ‹Ðµ Ð¼Ð¸Ð½ÑƒÑÑ‹.\n\n"
            "ÐŸÐ¾Ð¿Ñ€Ð¾Ð±ÑƒÐ¹ Ð½ÐµÐ¼Ð½Ð¾Ð³Ð¾ ÑƒÑ‚Ð¾Ñ‡Ð½Ð¸Ñ‚ÑŒ Ð·Ð°Ð¿Ñ€Ð¾Ñ, Ð¸ Ñ Ð¿Ð¾ÑÑ‚Ð°Ñ€Ð°ÑŽÑÑŒ Ð¿Ð¾Ð¼Ð¾Ñ‡ÑŒ Ð±Ð¾Ð»ÐµÐµ Ð¿Ñ€ÐµÐ´Ð¼ÐµÑ‚Ð½Ð¾ ðŸ¦Š"
        )


# ----------------- ENDPOINT -----------------


@app.post("/marketfox")
async def marketfox_endpoint(payload: Dict[str, Any] = Body(...)) -> Dict[str, str]:
    """
    ÐžÑÐ½Ð¾Ð²Ð½Ð¾Ð¹ Ð²ÐµÐ±Ñ…ÑƒÐº Ð´Ð»Ñ BotHelp.

    Ð˜Ð· payload Ð±ÐµÑ€Ñ‘Ð¼ Ð¿Ð¾Ð»Ðµ "Ð—Ð°Ð¿Ñ€Ð¾Ñ" (Ñ‡Ñ‚Ð¾ Ð·Ð° Ñ‚Ð¾Ð²Ð°Ñ€ Ð¸Ñ‰ÐµÑ‚ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ).
    scenario Ð¼Ð¾Ð¶Ð½Ð¾ Ð¿Ñ€Ð¾Ð±Ñ€Ð°ÑÑ‹Ð²Ð°Ñ‚ÑŒ Ð¸Ð· BotHelp (Ð½Ð°Ð¿Ñ€Ð¸Ð¼ÐµÑ€, 'product_pick', 'gift' Ð¸ Ñ‚.Ð¿.),
    Ð½Ð¾ Ð¿Ð¾ ÑƒÐ¼Ð¾Ð»Ñ‡Ð°Ð½Ð¸ÑŽ ÑÑ‡Ð¸Ñ‚Ð°ÐµÐ¼, Ñ‡Ñ‚Ð¾ ÑÐµÐ¹Ñ‡Ð°Ñ Ð¸Ð´Ñ‘Ñ‚ Ð¿Ð¾Ð´Ð±Ð¾Ñ€ Ñ‚Ð¾Ð²Ð°Ñ€Ð°.
    """
    logger.info("Incoming payload keys: %s", list(payload.keys()))

    # Ð§Ñ‚Ð¾ Ð½Ð°Ð¿Ð¸ÑÐ°Ð» Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ
    query = str(payload.get("Ð—Ð°Ð¿Ñ€Ð¾Ñ") or "").strip()

    # Ð¡Ñ†ÐµÐ½Ð°Ñ€Ð¸Ð¹ Ð¼Ð¾Ð¶Ð½Ð¾ Ð¿ÐµÑ€ÐµÐ´Ð°Ð²Ð°Ñ‚ÑŒ Ð¸Ð· BotHelp Ñ‡ÐµÑ€ÐµÐ· ÑÐºÑ€Ñ‹Ñ‚Ð¾Ðµ Ð¿Ð¾Ð»Ðµ/Ð¼ÐµÑ‚ÐºÑƒ
    scenario = (
        str(payload.get("scenario") or payload.get("Ð¡Ñ†ÐµÐ½Ð°Ñ€Ð¸Ð¹") or "product_pick").strip()
    )

    logger.info("User scenario=%s query=%s", scenario, query)

    if not query:
        # ÐÐ¸Ñ‡ÐµÐ³Ð¾ Ð½Ðµ Ð½Ð°Ð¿Ð¸ÑÐ°Ð»Ð¸ â€” Ð¼ÑÐ³ÐºÐ¾ Ð¿Ñ€Ð¾ÑÐ¸Ð¼ ÑÑ„Ð¾Ñ€Ð¼ÑƒÐ»Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ Ð·Ð°Ð¿Ñ€Ð¾Ñ
        reply_text = (
            "ÐŸÐ¾Ñ…Ð¾Ð¶Ðµ, Ð²Ñ‹ Ð¿Ð¾ÐºÐ° Ð½Ðµ ÑƒÐºÐ°Ð·Ð°Ð»Ð¸, Ñ‡Ñ‚Ð¾ Ð¸Ð¼ÐµÐ½Ð½Ð¾ Ð¸Ñ‰ÐµÑ‚Ðµ. "
            "ÐÐ°Ð¿Ð¸ÑˆÐ¸Ñ‚Ðµ Ð¾Ð´Ð½Ð¸Ð¼ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸ÐµÐ¼, ÐºÐ°ÐºÐ¾Ð¹ Ñ‚Ð¾Ð²Ð°Ñ€ Ð²Ð°Ð¼ Ð½ÑƒÐ¶ÐµÐ½ Ð¸ Ð¿Ñ€Ð¸Ð¼ÐµÑ€Ð½Ñ‹Ð¹ Ð±ÑŽÐ´Ð¶ÐµÑ‚, "
            "Ð½Ð°Ð¿Ñ€Ð¸Ð¼ÐµÑ€: Â«ÑÐ¼Ð°Ñ€Ñ‚Ñ„Ð¾Ð½ Ð´Ð¾ 20 000Â» Ð¸Ð»Ð¸ Â«Ð¼Ð¾Ð»Ð¾Ñ‚Ð¾Ðº Ð´Ð¾ 3000 Ñ€ÐµÐ·Ð¸Ð½Ð¾Ð²Ñ‹Ð¹Â»."
        )
        return {"reply_text": reply_text, "scenario": scenario}

    reply_text = await generate_reply(scenario, query)

    return {
        "reply_text": reply_text,
        "scenario": scenario,
    }


# ----------------- HEALTHCHECK -----------------


@app.get("/")
async def root() -> Dict[str, str]:
    return {"status": "ok", "message": "MarketFox backend is running"}


# ----------------- LOCAL RUN -----------------

if __name__ == "__main__":
    uvicorn.run(
        "main:app",
        host="0.0.0.0",
        port=int(os.environ.get("PORT", 8000)),
        reload=False,
    )
