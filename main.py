import os
import logging
from typing import Any, Dict, Optional

from fastapi import FastAPI
from pydantic import BaseModel
from openai import OpenAI

# =========================
# –õ–û–ì–ò–†–û–í–ê–ù–ò–ï
# =========================
logging.basicConfig(level=logging.INFO)
logger = logging.getLogger("marketfox")

# =========================
# DeepSeek API –∫–ª–∏–µ–Ω—Ç
# =========================
# –í Render/OpenAI ENV —Ç—ã –∫–ª–∞–¥—ë—à—å —Å—é–¥–∞ —Å–≤–æ–π –∫–ª—é—á DeepSeek
DEEPSEEK_API_KEY = os.getenv("OPENAI_API_KEY")

client: Optional[OpenAI]
if DEEPSEEK_API_KEY:
    # –ò—Å–ø–æ–ª—å–∑—É–µ–º openai-–∫–ª–∏–µ–Ω—Ç, –Ω–æ —à–ª—ë–º –∑–∞–ø—Ä–æ—Å—ã –≤ DeepSeek
    client = OpenAI(
        api_key=DEEPSEEK_API_KEY,
        base_url="https://api.deepseek.com",
    )
else:
    client = None
    logger.warning("OPENAI_API_KEY (DeepSeek) is not set. Using fallback answers.")


# =========================
# –ú–û–î–ï–õ–ò
# =========================
class GenericPayload(BaseModel):
    """–ü—Ä–∏–Ω–∏–º–∞–µ–º –ø—Ä–æ–∏–∑–≤–æ–ª—å–Ω—ã–π JSON –æ—Ç BotHelp."""
    __root__: Dict[str, Any]


# =========================
# –£–¢–ò–õ–ò–¢–´
# =========================
def extract_query(data: Dict[str, Any]) -> Optional[str]:
    """
    –ü—ã—Ç–∞–µ–º—Å—è –¥–æ—Å—Ç–∞—Ç—å —Ç–µ–∫—Å—Ç –∑–∞–ø—Ä–æ—Å–∞ –∏–∑ —Ä–∞–∑–Ω—ã—Ö –≤–æ–∑–º–æ–∂–Ω—ã—Ö –ø–æ–ª–µ–π.
    –û—Å–Ω–æ–≤–Ω–æ–π –∫–µ–π—Å: –ø–æ–ª–µ '–ó–∞–ø—Ä–æ—Å' (—Ä—É—Å—Å–∫–æ–µ).
    """
    for key in ("–ó–∞–ø—Ä–æ—Å", "query", "message", "text"):
        value = data.get(key)
        if isinstance(value, str) and value.strip():
            return value.strip()
    return None


def detect_scenario(text: str) -> str:
    """
    –ì—Ä—É–±–∞—è —ç–≤—Ä–∏—Å—Ç–∏–∫–∞:
    - 'gift'      ‚Äî –∑–∞–ø—Ä–æ—Å –ø—Ä–æ –ø–æ–¥–∞—Ä–æ–∫
    - 'compare'   ‚Äî —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–æ–≤
    - 'product_pick' ‚Äî –≤—Å—ë –æ—Å—Ç–∞–ª—å–Ω–æ–µ (–ø–æ–¥–±–æ—Ä —Ç–æ–≤–∞—Ä–∞)
    """
    lower = text.lower()

    gift_keywords = [
        "–ø–æ–¥–∞—Ä–æ–∫", "–ø–æ–¥–∞—Ä–∏—Ç—å", "–¥–ª—è –¥–µ–≤—É—à–∫–∏", "–¥–ª—è –ø–∞—Ä–Ω—è",
        "–¥–ª—è –º–∞–º—ã", "–¥–ª—è –ø–∞–ø—ã", "–¥–ª—è –∂–µ–Ω—ã", "–¥–ª—è –º—É–∂–∞",
        "–Ω–∞ –¥—Ä", "–Ω–∞ –¥–µ–Ω—å —Ä–æ–∂–¥–µ–Ω–∏—è", "–Ω–∞ –Ω–æ–≤—ã–π –≥–æ–¥", "–Ω–∞ –Ω–≥",
    ]
    compare_keywords = ["—Å—Ä–∞–≤–Ω–∏", "—á—Ç–æ –ª—É—á—à–µ", "vs", "–ø—Ä–æ—Ç–∏–≤", "—Å—Ä–∞–≤–Ω–µ–Ω–∏–µ"]

    if any(k in lower for k in gift_keywords):
        return "gift"
    if any(k in lower for k in compare_keywords):
        return "compare"

    return "product_pick"


async def generate_reply(query: str, scenario: str) -> str:
    """
    –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –æ—Ç–≤–µ—Ç –æ—Ç MarketFox.
    –ï—Å–ª–∏ –Ω–µ—Ç –∫–ª–∏–µ–Ω—Ç–∞ (–Ω–µ—Ç –∫–ª—é—á–∞) –∏–ª–∏ —Å–ª—É—á–∏–ª–∞—Å—å –æ—à–∏–±–∫–∞ ‚Äî –æ—Ç–¥–∞—ë–º –¥—Ä—É–∂–µ–ª—é–±–Ω—ã–π —Ñ–æ–ª–ª–±–µ–∫.
    """
    if client is None:
        # –§–æ–ª–ª–±–µ–∫ –±–µ–∑ –ò–ò ‚Äî –±–∞–∑–æ–≤—ã–π –∞–ª–≥–æ—Ä–∏—Ç–º –≤—ã–±–æ—Ä–∞
        return (
            "–Ø –ø–æ–∫–∞ –Ω–µ –ø–æ–¥–∫–ª—é—á—ë–Ω –∫ –Ω–µ–π—Ä–æ—Å–µ—Ç–∏, –Ω–æ –≤–æ—Ç –∫–∞–∫ –º–æ–∂–Ω–æ –ø–æ–¥–æ–π—Ç–∏ –∫ –≤—ã–±–æ—Ä—É:\n\n"
            "1) –û–ø—Ä–µ–¥–µ–ª–∏ –±—é–¥–∂–µ—Ç –∏ 1‚Äì2 –≥–ª–∞–≤–Ω—ã–µ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ —Ç–æ–≤–∞—Ä–∞.\n"
            "2) –û—Ç—Å–µ–π –≤–∞—Ä–∏–∞–Ω—Ç—ã –±–µ–∑ –æ—Ç–∑—ã–≤–æ–≤ –∏ —Å –æ—Ç–∫—Ä–æ–≤–µ–Ω–Ω–æ —Å—Ç—Ä–∞–Ω–Ω–æ –Ω–∏–∑–∫–æ–π —Ü–µ–Ω–æ–π.\n"
            "3) –°—Ä–∞–≤–Ω–∏ 3‚Äì5 –∞–¥–µ–∫–≤–∞—Ç–Ω—ã—Ö –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ –ø–æ —Å–∞–º—ã–º –≤–∞–∂–Ω—ã–º –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º.\n"
            "4) –ü–æ—á–∏—Ç–∞–π –Ω–µ–≥–∞—Ç–∏–≤–Ω—ã–µ –æ—Ç–∑—ã–≤—ã ‚Äî –æ–Ω–∏ –ª—É—á—à–µ –≤—Å–µ–≥–æ –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç —Ä–µ–∞–ª—å–Ω—ã–µ –º–∏–Ω—É—Å—ã.\n\n"
            "–ö–æ–≥–¥–∞ –ø–æ–¥–∫–ª—é—á–∏–º –ò–ò, —è —Å–º–æ–≥—É –≤—Å—ë —ç—Ç–æ –¥–µ–ª–∞—Ç—å –∑–∞ —Ç–µ–±—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ ü¶ä"
        )

    base_instructions = (
        "–¢—ã ‚Äî MarketFox, —É–º–Ω—ã–π –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –ø–æ –≤—ã–±–æ—Ä—É —Ç–æ–≤–∞—Ä–æ–≤ –Ω–∞ –º–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å–∞—Ö "
        "(–Ω–∞–ø—Ä–∏–º–µ—Ä, Wildberries –∏ Ozon) –¥–ª—è —Ä—É—Å—Å–∫–æ—è–∑—ã—á–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π. "
        "–¢—ã –ù–ï –≤–∏–¥–∏—à—å —Ä–µ–∞–ª—å–Ω—ã–µ –∫–∞—Ä—Ç–æ—á–∫–∏ —Ç–æ–≤–∞—Ä–æ–≤, –ø–æ—ç—Ç–æ–º—É –¥–µ–π—Å—Ç–≤—É–µ—à—å –∫–∞–∫ –∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç:\n"
        "- –ø–æ–º–æ–≥–∞–µ—à—å —Å—É–∑–∏—Ç—å –∑–∞–ø—Ä–æ—Å;\n"
        "- –ø–æ–¥—Å–∫–∞–∑—ã–≤–∞–µ—à—å, –∫–∞–∫–∏–µ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ –≤–∞–∂–Ω—ã;\n"
        "- –ø—Ä–µ–¥–ª–∞–≥–∞–µ—à—å, –∫–∞–∫ —Å—Ä–∞–≤–Ω–∏–≤–∞—Ç—å —Ä–∞–∑–Ω—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã;\n"
        "- –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–∞–µ—à—å –æ —Ç–∏–ø–∏—á–Ω—ã—Ö –ø–æ–¥–≤–æ–¥–Ω—ã—Ö –∫–∞–º–Ω—è—Ö.\n\n"
        "–û—Ç–≤–µ—á–∞–π –∫—Ä–∞—Ç–∫–æ, –ø–æ –¥–µ–ª—É, —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–æ. –ü–∏—à–∏ –Ω–∞ —Ä—É—Å—Å–∫–æ–º, –∏—Å–ø–æ–ª—å–∑—É–π —Å–ø–∏—Å–∫–∏, "
        "–∏–∑–±–µ–≥–∞–π –¥–ª–∏–Ω–Ω—ã—Ö –ø—Ä–æ—Å—Ç—ã–Ω–µ–π —Ç–µ–∫—Å—Ç–∞."
    )

    if scenario == "gift":
        scenario_hint = (
            "–°—Ü–µ–Ω–∞—Ä–∏–π: –≤—ã–±–æ—Ä –ø–æ–¥–∞—Ä–∫–∞. –û—Å–Ω–æ–≤—ã–≤–∞–π—Å—è –Ω–∞ –∑–∞–ø—Ä–æ—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è. "
            "–ü—Ä–µ–¥–ª–æ–∂–∏ 3‚Äì7 –∏–¥–µ–π –ø–æ–¥–∞—Ä–∫–æ–≤ –≤ —Ä–∞–∑–Ω—ã—Ö —Ü–µ–Ω–æ–≤—ã—Ö –¥–∏–∞–ø–∞–∑–æ–Ω–∞—Ö –∏ —Å—Ç–∏–ª—è—Ö. "
            "–û–±—ä—è—Å–Ω–∏, –ø–æ—á–µ–º—É –∫–∞–∂–¥–∞—è –∏–¥–µ—è –º–æ–∂–µ—Ç –ø–æ–¥–æ–π—Ç–∏. "
            "–ï—Å–ª–∏ –¥–∞–Ω–Ω—ã—Ö –º–∞–ª–æ (–Ω–µ —É–∫–∞–∑–∞–Ω –≤–æ–∑—Ä–∞—Å—Ç, –ø–æ–ª, –∏–Ω—Ç–µ—Ä–µ—Å—ã –∏ —Ç.–ø.), "
            "–º—è–≥–∫–æ —É—Ç–æ—á–Ω–∏, —á—Ç–æ –µ—â—ë –º–æ–∂–Ω–æ –Ω–∞–ø–∏—Å–∞—Ç—å, —á—Ç–æ–±—ã –ø–æ–¥–æ–±—Ä–∞—Ç—å –ª—É—á—à–µ."
        )
    elif scenario == "compare":
        scenario_hint = (
            "–°—Ü–µ–Ω–∞—Ä–∏–π: —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ –¥–≤—É—Ö –∏–ª–∏ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö —Ç–æ–≤–∞—Ä–æ–≤. "
            "–ü–æ–º–æ–≥–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –ø–æ–Ω—è—Ç—å, –ø–æ –∫–∞–∫–∏–º –∫—Ä–∏—Ç–µ—Ä–∏—è–º —Å—Ä–∞–≤–Ω–∏–≤–∞—Ç—å —Ç–æ–≤–∞—Ä—ã: "
            "–∫–∞—á–µ—Å—Ç–≤–æ, —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª, –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç—å, –≥–∞—Ä–∞–Ω—Ç–∏—è, –æ—Ç–∑—ã–≤—ã, –±—Ä–µ–Ω–¥, —Å–∫—Ä—ã—Ç—ã–µ –º–∏–Ω—É—Å—ã. "
            "–î–∞–π —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —á–µ–∫-–ª–∏—Å—Ç –∏ –ø–æ–¥—Å–∫–∞–∑–∫–∏, –∫–∞–∫ –ø—Ä–∏–Ω—è—Ç—å —Ä–µ—à–µ–Ω–∏–µ, "
            "–¥–∞–∂–µ –µ—Å–ª–∏ —É —Ç–µ–±—è –Ω–µ—Ç –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫ –º–æ–¥–µ–ª–µ–π."
        )
    else:
        scenario_hint = (
            "–°—Ü–µ–Ω–∞—Ä–∏–π: –ø–æ–¥–±–æ—Ä –æ–¥–Ω–æ–≥–æ —Ç–æ–≤–∞—Ä–∞ –ø–æ–¥ –∑–∞–ø—Ä–æ—Å. "
            "–ü–æ–º–æ–≥–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é —Å—É–∑–∏—Ç—å –≤—ã–±–æ—Ä –∏ –ø–æ–Ω—è—Ç—å, –∫–∞–∫–æ–π —Ç–∏–ø —Ç–æ–≤–∞—Ä–∞ –∏–ª–∏ "
            "–∫–∞–∫–∏–µ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ –µ–º—É –ø–æ–¥–æ–π–¥—É—Ç. "
            "–ü—Ä–µ–¥–ª–æ–∂–∏ 3‚Äì7 –∏–¥–µ–π, —á—Ç–æ –∏—Å–∫–∞—Ç—å (—Ç–∏–ø—ã —Ç–æ–≤–∞—Ä–æ–≤, —Ñ—É–Ω–∫—Ü–∏–∏, –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏), "
            "–Ω–æ –ù–ï –ø—Ä–∏–¥—É–º—ã–≤–∞–π –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –º–æ–¥–µ–ª–∏ —Å —Ñ–∞–Ω—Ç–∞–∑–∏–π–Ω—ã–º–∏ –Ω–∞–∑–≤–∞–Ω–∏—è–º–∏."
        )

    system_prompt = base_instructions + "\n\n" + scenario_hint

    try:
        response = client.chat.completions.create(
            model="deepseek-chat",
            messages=[
                {"role": "system", "content": system_prompt},
                {"role": "user", "content": query},
            ],
            temperature=0.7,
        )
        reply_text = response.choices[0].message.content.strip()
        return reply_text
    except Exception as e:
        logger.exception("DeepSeek API error: %s", e)
        return (
            "–°–µ–π—á–∞—Å —è –Ω–µ –º–æ–≥—É –æ–±—Ä–∞—Ç–∏—Ç—å—Å—è –∫ –Ω–µ–π—Ä–æ—Å–µ—Ç–∏, –Ω–æ –≤–æ—Ç –±–∞–∑–æ–≤—ã–π –∞–ª–≥–æ—Ä–∏—Ç–º –≤—ã–±–æ—Ä–∞:\n"
            "1) –°—É–∑—å –±—é–¥–∂–µ—Ç –∏ —É–±–µ—Ä–∏ –æ—Ç–∫—Ä–æ–≤–µ–Ω–Ω–æ –¥–µ—à—ë–≤—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã –±–µ–∑ –æ—Ç–∑—ã–≤–æ–≤.\n"
            "2) –í—ã–±–µ—Ä–∏ 3‚Äì5 –∞–¥–µ–∫–≤–∞—Ç–Ω—ã—Ö —Ç–æ–≤–∞—Ä–æ–≤ –∏ —Å—Ä–∞–≤–Ω–∏ –∏—Ö –ø–æ 3‚Äì4 –∫–ª—é—á–µ–≤—ã–º –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º.\n"
            "3) –ü–æ—Å–º–æ—Ç—Ä–∏ –Ω–µ–≥–∞—Ç–∏–≤–Ω—ã–µ –æ—Ç–∑—ã–≤—ã ‚Äî –æ–Ω–∏ –ø–æ–∫–∞–∂—É—Ç —Ä–µ–∞–ª—å–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã.\n\n"
            "–ü–æ–ø—Ä–æ–±—É–π –Ω–µ–º–Ω–æ–≥–æ –ø–æ–∑–∂–µ –µ—â—ë —Ä–∞–∑ –Ω–∞–ø–∏—Å–∞—Ç—å –∑–∞–ø—Ä–æ—Å ‚Äî —è –ø–æ—Å—Ç–∞—Ä–∞—é—Å—å –ø–æ–º–æ—á—å –ø–æ–¥—Ä–æ–±–Ω–µ–µ ü¶ä."
        )


# =========================
# FASTAPI
# =========================
app = FastAPI(
    title="MarketFox API (DeepSeek)",
    description="Backend for MarketFox marketplace assistant (powered by DeepSeek)",
    version="0.2.0",
)


@app.post("/marketfox")
async def marketfox_endpoint(payload: GenericPayload) -> Dict[str, Any]:
    """
    –û—Å–Ω–æ–≤–Ω–æ–π —ç–Ω–¥–ø–æ–∏–Ω—Ç, –∫–æ—Ç–æ—Ä—ã–π –±—É–¥–µ—Ç –≤—ã–∑—ã–≤–∞—Ç—å BotHelp.

    –û–∂–∏–¥–∞–µ–º JSON —Å –ø—Ä–æ–∏–∑–≤–æ–ª—å–Ω—ã–º–∏ –ø–æ–ª—è–º–∏, –Ω–æ –≥–ª–∞–≤–Ω–æ–µ ‚Äî –ø–æ–ª–µ '–ó–∞–ø—Ä–æ—Å'
    (–∏–ª–∏ 'query' / 'message' / 'text').
    """
    data: Dict[str, Any] = payload.__root__ or {}
    logger.info("Incoming payload keys: %s", list(data.keys()))

    text_query = extract_query(data)
    user_id = str(data.get("user_id") or data.get("bothelp_user_id") or "")

    if not text_query:
        logger.warning("No query text found in payload from user_id=%s", user_id)
        return {
            "reply_text": (
                "–Ø –Ω–µ —É–≤–∏–¥–µ–ª –≤ –∑–∞–ø—Ä–æ—Å–µ —Ç–µ–∫—Å—Ç. –ù–∞–ø–∏—à–∏, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ–¥–Ω–∏–º —Å–æ–æ–±—â–µ–Ω–∏–µ–º, "
                "—á—Ç–æ —Ç—ã —Ö–æ—á–µ—à—å –Ω–∞–π—Ç–∏, –¥–ª—è –∫–æ–≥–æ —ç—Ç–æ –∏ –≤ –∫–∞–∫–æ–º –±—é–¥–∂–µ—Ç–µ."
            ),
            "scenario": "unknown",
        }

    scenario = detect_scenario(text_query)
    logger.info("User %s scenario=%s query=%s", user_id, scenario, text_query[:80])

    reply_text = await generate_reply(text_query, scenario)

    return {
        "reply_text": reply_text,
        "scenario": scenario,
    }
