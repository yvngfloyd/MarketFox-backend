import os
import logging
from typing import Any, Dict, Optional

from fastapi import FastAPI
from pydantic import BaseModel
from openai import OpenAI

# ====== –õ–û–ì–ò ======
logging.basicConfig(level=logging.INFO)
logger = logging.getLogger("marketfox")

# ====== OpenAI –∫–ª–∏–µ–Ω—Ç ======
OPENAI_API_KEY = os.getenv("OPENAI_API_KEY")
client = OpenAI(api_key=OPENAI_API_KEY) if OPENAI_API_KEY else None

app = FastAPI(
    title="MarketFox API",
    description="Backend for MarketFox marketplace assistant",
    version="0.1.0",
)


class GenericPayload(BaseModel):
    """–ü—Ä–∏–Ω–∏–º–∞–µ–º –ª—é–±–æ–π JSON –æ—Ç BotHelp."""
    __root__: Dict[str, Any]


def extract_query(data: Dict[str, Any]) -> Optional[str]:
    """–ü—ã—Ç–∞–µ–º—Å—è –¥–æ—Å—Ç–∞—Ç—å —Ç–µ–∫—Å—Ç –∑–∞–ø—Ä–æ—Å–∞ –∏–∑ —Ä–∞–∑–Ω—ã—Ö –ø–æ–ª–µ–π."""
    for key in ("–ó–∞–ø—Ä–æ—Å", "query", "message", "text"):
        value = data.get(key)
        if isinstance(value, str) and value.strip():
            return value.strip()
    return None


def detect_scenario(text: str) -> str:
    """–ì—Ä—É–±–∞—è —ç–≤—Ä–∏—Å—Ç–∏–∫–∞: product_pick / gift / compare."""
    lower = text.lower()

    gift_keywords = ["–ø–æ–¥–∞—Ä–æ–∫", "–ø–æ–¥–∞—Ä–∏", "–¥–ª—è –¥–µ–≤—É—à–∫–∏", "–¥–ª—è –ø–∞—Ä–Ω—è",
                     "–¥–ª—è –º–∞–º—ã", "–¥–ª—è –ø–∞–ø—ã", "–Ω–∞ –¥—Ä", "–Ω–∞ –¥–µ–Ω—å —Ä–æ–∂–¥–µ–Ω–∏—è"]
    compare_keywords = ["—Å—Ä–∞–≤–Ω–∏", "—á—Ç–æ –ª—É—á—à–µ", "vs", "–ø—Ä–æ—Ç–∏–≤", "—Å—Ä–∞–≤–Ω–µ–Ω–∏–µ"]

    if any(k in lower for k in gift_keywords):
        return "gift"
    if any(k in lower for k in compare_keywords):
        return "compare"

    # –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é ‚Äî –ø–æ–¥–±–æ—Ä —Ç–æ–≤–∞—Ä–∞
    return "product_pick"


async def generate_reply(query: str, scenario: str) -> str:
    """–ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –æ—Ç–≤–µ—Ç —á–µ—Ä–µ–∑ OpenAI."""
    if client is None:
        # –µ—Å–ª–∏ –Ω–µ—Ç API-–∫–ª—é—á–∞ ‚Äî –¥—Ä—É–∂–µ–ª—é–±–Ω—ã–π —Ñ–æ–ª–ª–±–µ–∫
        return (
            "–Ø –ø–æ–∫–∞ –Ω–µ –ø–æ–¥–∫–ª—é—á—ë–Ω –∫ –Ω–µ–π—Ä–æ—Å–µ—Ç–∏, –Ω–æ –≤–æ—Ç –∫–∞–∫ –º–æ–∂–Ω–æ –ø–æ–¥–æ–π—Ç–∏ –∫ –≤—ã–±–æ—Ä—É:\n\n"
            "1) –°—Ñ–æ—Ä–º—É–ª–∏—Ä—É–π, —á—Ç–æ –∏–º–µ–Ω–Ω–æ —Ç–µ–±–µ –≤–∞–∂–Ω–æ –≤ —Ç–æ–≤–∞—Ä–µ (–±—Ä–µ–Ω–¥, —Ü–µ–Ω–∞, —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏).\n"
            "2) –û—Ç–±—Ä–æ—Å—å –≤–∞—Ä–∏–∞–Ω—Ç—ã —Å –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω–æ –Ω–∏–∑–∫–æ–π —Ü–µ–Ω–æ–π –∏ –±–µ–∑ –æ—Ç–∑—ã–≤–æ–≤.\n"
            "3) –°–º–æ—Ç—Ä–∏ –Ω–µ —Ç–æ–ª—å–∫–æ –Ω–∞ —Ä–µ–π—Ç–∏–Ω–≥, –Ω–æ –∏ –Ω–∞ —Å–æ–¥–µ—Ä–∂–∞–Ω–∏–µ –æ—Ç–∑—ã–≤–æ–≤.\n"
            "4) –°—Ä–∞–≤–Ω–∏ 3‚Äì5 –∞–¥–µ–∫–≤–∞—Ç–Ω—ã—Ö –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ –ø–æ 3‚Äì4 –∫–ª—é—á–µ–≤—ã–º –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º.\n\n"
            "–ö–æ–≥–¥–∞ –ø–æ–¥–∫–ª—é—á–∏–º –ò–ò ‚Äî —è —Å–º–æ–≥—É –¥–µ–ª–∞—Ç—å —ç—Ç–æ –∑–∞ —Ç–µ–±—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ ü¶ä"
        )

    # —Å–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç –ø–æ–¥ —Ä–∞–∑–Ω—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏
    base_instructions = (
        "–¢—ã ‚Äî MarketFox, —É–º–Ω—ã–π –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –ø–æ –≤—ã–±–æ—Ä—É —Ç–æ–≤–∞—Ä–æ–≤ –Ω–∞ –º–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å–∞—Ö "
        "–¥–ª—è —Ä—É—Å—Å–∫–æ—è–∑—ã—á–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π. –¢—ã –Ω–µ –≤–∏–¥–∏—à—å —Ä–µ–∞–ª—å–Ω—ã—Ö –∫–∞—Ä—Ç–æ—á–µ–∫ —Ç–æ–≤–∞—Ä–æ–≤, "
        "–ø–æ—ç—Ç–æ–º—É –¥–µ–π—Å—Ç–≤—É–µ—à—å –∫–∞–∫ –∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç: –ø–æ–¥—Å–∫–∞–∑—ã–≤–∞–µ—à—å, –Ω–∞ —á—Ç–æ –æ–±—Ä–∞—Ç–∏—Ç—å –≤–Ω–∏–º–∞–Ω–∏–µ, "
        "–∫–∞–∫–∏–µ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ —Å—Ä–∞–≤–Ω–∏—Ç—å, –∫–∞–∫–∏–µ —Ç–∏–ø—ã —Ç–æ–≤–∞—Ä–æ–≤ —Ä–∞—Å—Å–º–æ—Ç—Ä–µ—Ç—å. "
        "–ü–∏—à–∏ –∫—Ä–∞—Ç–∫–æ, —Å—Ç—Ä—É–∫—Ç—É—Ä–Ω–æ, –Ω–∞ —Ä—É—Å—Å–∫–æ–º. –ò—Å–ø–æ–ª—å–∑—É–π –º–∞—Ä–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Å–ø–∏—Å–∫–∏, "
        "–∏–∑–±–µ–≥–∞–π –≤–æ–¥—ã –∏ –¥–ª–∏–Ω–Ω—ã—Ö –ø—Ä–æ—Å—Ç—ã–Ω–µ–π."
    )

    if scenario == "gift":
        scenario_hint = (
            "–°—Ü–µ–Ω–∞—Ä–∏–π: –≤—ã–±–æ—Ä –ø–æ–¥–∞—Ä–∫–∞. –ü—Ä–µ–¥–ª–æ–∂–∏ 3‚Äì7 –∏–¥–µ–π –ø–æ–¥–∞—Ä–∫–æ–≤, –∏—Å—Ö–æ–¥—è –∏–∑ –∑–∞–ø—Ä–æ—Å–∞, "
            "—Ä–∞–∑–Ω—ã—Ö –ø–æ –±—é–¥–∂–µ—Ç—É –∏ —Å—Ç–∏–ª—é. –û–±—ä—è—Å–Ω–∏, –ø–æ—á–µ–º—É —ç—Ç–æ —É–º–µ—Å—Ç–Ω–æ. "
            "–ï—Å–ª–∏ –≤ –∑–∞–ø—Ä–æ—Å–µ –º–∞–ª–æ –¥–∞–Ω–Ω—ã—Ö, –º—è–≥–∫–æ —É—Ç–æ—á–Ω–∏, —á—Ç–æ –µ—â—ë –≤–∞–∂–Ω–æ –∑–Ω–∞—Ç—å."
        )
    elif scenario == "compare":
        scenario_hint = (
            "–°—Ü–µ–Ω–∞—Ä–∏–π: —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ –¥–≤—É—Ö –∏–ª–∏ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö —Ç–æ–≤–∞—Ä–æ–≤. "
            "–û–ø–∏—à–∏, –ø–æ –∫–∞–∫–∏–º –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º –∏—Ö –æ–±—ã—á–Ω–æ —Å—Ä–∞–≤–Ω–∏–≤–∞—Ç—å (–∫–∞—á–µ—Å—Ç–≤–æ, —Ñ—É–Ω–∫—Ü–∏–∏, –≥–∞—Ä–∞–Ω—Ç–∏—è, "
            "–æ—Ç–∑—ã–≤—ã, –±—Ä–µ–Ω–¥—ã, —Å–∫—Ä—ã—Ç—ã–µ –º–∏–Ω—É—Å—ã). –î–∞–π —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Å–æ–≤–µ—Ç—ã, "
            "–∫–∞–∫ —Å–∞–º–æ–º—É –ø—Ä–∏–Ω—è—Ç—å —Ä–µ—à–µ–Ω–∏–µ, –¥–∞–∂–µ –±–µ–∑ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö –º–æ–¥–µ–ª–µ–π."
        )
    else:
        scenario_hint = (
            "–°—Ü–µ–Ω–∞—Ä–∏–π: –ø–æ–¥–±–æ—Ä –æ–¥–Ω–æ–≥–æ —Ç–æ–≤–∞—Ä–∞ –ø–æ–¥ –∑–∞–ø—Ä–æ—Å. "
            "–ü–æ–º–æ–≥–∏ —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å –∫—Ä–∏—Ç–µ—Ä–∏–∏ –≤—ã–±–æ—Ä–∞, –ø–æ–¥—Å–∫–∞–∂–∏, –∫–∞–∫–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏ –≤–∞–∂–Ω—ã, "
            "–∫–∞–∫–∏–µ –æ–ø—Ü–∏–∏ –º–æ–∂–Ω–æ –æ—Ç–±—Ä–æ—Å–∏—Ç—å. –ü—Ä–∏–≤–µ–¥–∏ 3‚Äì7 –ø—Ä–∏–º–µ—Ä–æ–≤ —Ç–∏–ø–æ–≤ —Ç–æ–≤–∞—Ä–æ–≤ –∏–ª–∏ "
            "—Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫, –∫–æ—Ç–æ—Ä—ã–µ —Å—Ç–æ–∏—Ç –∏—Å–∫–∞—Ç—å, –Ω–æ –Ω–µ –≤—ã–¥—É–º—ã–≤–∞–π –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –º–æ–¥–µ–ª–∏."
        )

    system_prompt = base_instructions + "\n\n" + scenario_hint

    try:
        response = client.chat.completions.create(
            model="gpt-4.1-mini",
            messages=[
                {"role": "system", "content": system_prompt},
                {"role": "user", "content": query},
            ],
            temperature=0.7,
        )
        reply_text = response.choices[0].message.content.strip()
        return reply_text
    except Exception as e:
        logger.exception("OpenAI error: %s", e)
        return (
            "–°–µ–π—á–∞—Å —è –Ω–µ –º–æ–≥—É –æ–±—Ä–∞—Ç–∏—Ç—å—Å—è –∫ –Ω–µ–π—Ä–æ—Å–µ—Ç–∏, –Ω–æ –≤–æ—Ç –±–∞–∑–æ–≤—ã–π –∞–ª–≥–æ—Ä–∏—Ç–º –≤—ã–±–æ—Ä–∞:\n"
            "1) –°—É–∑—å –±—é–¥–∂–µ—Ç –∏ 1‚Äì2 –∫–ª—é—á–µ–≤—ã–µ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏.\n"
            "2) –û—Ç—Å–µ–π –≤–∞—Ä–∏–∞–Ω—Ç—ã –±–µ–∑ –æ—Ç–∑—ã–≤–æ–≤ –∏ —Å –±–æ–ª—å—à–∏–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º –º–∏–Ω—É—Å–æ–≤.\n"
            "3) –û—Å—Ç–∞–≤—à–∏–µ—Å—è 3‚Äì5 –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ —Å—Ä–∞–≤–Ω–∏ –ø–æ —Å–∞–º—ã–º –≤–∞–∂–Ω—ã–º –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º.\n\n"
            "–ü–æ–ø—Ä–æ–±—É–π –ø–µ—Ä–µ—Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∞—Ç—å –∑–∞–ø—Ä–æ—Å —á—É—Ç—å –ø–æ–∑–∂–µ ‚Äî —è –ø–æ—Å—Ç–∞—Ä–∞—é—Å—å –ø–æ–º–æ—á—å –ø–æ–¥—Ä–æ–±–Ω–µ–µ ü¶ä."
        )


@app.post("/marketfox")
async def marketfox_endpoint(payload: GenericPayload) -> Dict[str, Any]:
    data = payload.__root__ or {}
    logger.info("Incoming payload keys: %s", list(data.keys()))

    text_query = extract_query(data)
    user_id = str(data.get("user_id") or data.get("bothelp_user_id") or "")

    if not text_query:
        logger.warning("No query found in payload from user_id=%s", user_id)
        return {
            "reply_text": (
                "–Ø –Ω–µ —É–≤–∏–¥–µ–ª —Ç–µ–∫—Å—Ç–∞ –∑–∞–ø—Ä–æ—Å–∞. –ù–∞–ø–∏—à–∏, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ–¥–Ω–∏–º —Å–æ–æ–±—â–µ–Ω–∏–µ–º, "
                "—á—Ç–æ —Ç—ã —Ö–æ—á–µ—à—å –Ω–∞–π—Ç–∏, –∫–æ–º—É —ç—Ç–æ –∏ –≤ –∫–∞–∫–æ–º –±—é–¥–∂–µ—Ç–µ."
            ),
            "scenario": "unknown",
        }

    scenario = detect_scenario(text_query)
    logger.info(
        "User %s scenario=%s query=%s",
        user_id,
        scenario,
        text_query[:80],
    )

    reply_text = await generate_reply(text_query, scenario)

    return {
        "reply_text": reply_text,
        "scenario": scenario,
    }
