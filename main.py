import os
import logging
from typing import Any, Dict, List
from urllib.parse import quote_plus

import httpx
from fastapi import FastAPI, Body
from groq import Groq

# ----------------- Ğ›Ğ¾Ğ³Ğ³ĞµÑ€ -----------------
logger = logging.getLogger("marketfox")
logger.setLevel(logging.INFO)
handler = logging.StreamHandler()
handler.setFormatter(logging.Formatter("[%(asctime)s] %(levelname)s: %(message)s"))
logger.addHandler(handler)

# ----------------- ĞšĞ¾Ğ½Ñ„Ğ¸Ğ³ -----------------
GROQ_API_KEY = os.getenv("GROQ_API_KEY")

# Ğ‘Ğ°Ğ·Ğ¾Ğ²Ñ‹Ğ¹ fallback-Ğ¾Ñ‚Ğ²ĞµÑ‚, ĞºĞ¾Ğ³Ğ´Ğ° Ğ½ĞµĞ¹Ñ€Ğ¾ÑĞµÑ‚ÑŒ Ğ½ĞµĞ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ğ°
FALLBACK_TEXT = (
    "Ğ¡ĞµĞ¹Ñ‡Ğ°Ñ Ñ Ğ½Ğµ Ğ¼Ğ¾Ğ³Ñƒ Ğ¾Ğ±Ñ€Ğ°Ñ‚Ğ¸Ñ‚ÑŒÑÑ Ğº Ğ½ĞµĞ¹Ñ€Ğ¾ÑĞµÑ‚Ğ¸, Ğ½Ğ¾ Ğ²Ğ¾Ñ‚ ĞºĞ°Ğº Ğ¼Ğ¾Ğ¶Ğ½Ğ¾ Ğ¿Ğ¾Ğ´Ğ¾Ğ¹Ñ‚Ğ¸ Ğº Ğ²Ñ‹Ğ±Ğ¾Ñ€Ñƒ:\n\n"
    "1) ĞĞ¿Ñ€ĞµĞ´ĞµĞ»Ğ¸ Ğ±ÑĞ´Ğ¶ĞµÑ‚ Ğ¸ 1â€“2 Ğ³Ğ»Ğ°Ğ²Ğ½Ñ‹Ğµ Ñ…Ğ°Ñ€Ğ°ĞºÑ‚ĞµÑ€Ğ¸ÑÑ‚Ğ¸ĞºĞ¸ Ñ‚Ğ¾Ğ²Ğ°Ñ€Ğ°.\n"
    "2) ĞÑ‚ÑĞµĞ¹ Ğ²Ğ°Ñ€Ğ¸Ğ°Ğ½Ñ‚Ñ‹ Ğ±ĞµĞ· Ğ¾Ñ‚Ğ·Ñ‹Ğ²Ğ¾Ğ² Ğ¸ Ñ Ğ¾Ñ‡ĞµĞ½ÑŒ Ğ½Ğ¸Ğ·ĞºĞ¸Ğ¼ Ñ€ĞµĞ¹Ñ‚Ğ¸Ğ½Ğ³Ğ¾Ğ¼.\n"
    "3) Ğ¡Ñ€Ğ°Ğ²Ğ½Ğ¸ 3â€“5 Ğ°Ğ´ĞµĞºĞ²Ğ°Ñ‚Ğ½Ñ‹Ñ… Ğ¼Ğ¾Ğ´ĞµĞ»ĞµĞ¹ Ğ¿Ğ¾ ĞºĞ»ÑÑ‡ĞµĞ²Ñ‹Ğ¼ Ğ¿Ğ°Ñ€Ğ°Ğ¼ĞµÑ‚Ñ€Ğ°Ğ¼.\n"
    "4) ĞŸĞ¾ÑĞ¼Ğ¾Ñ‚Ñ€Ğ¸ Ğ½ĞµĞ³Ğ°Ñ‚Ğ¸Ğ²Ğ½Ñ‹Ğµ Ğ¾Ñ‚Ğ·Ñ‹Ğ²Ñ‹ â€” Ğ¾Ğ½Ğ¸ Ğ»ÑƒÑ‡ÑˆĞµ Ğ²ÑĞµĞ³Ğ¾ Ğ¿Ğ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°ÑÑ‚ Ñ€ĞµĞ°Ğ»ÑŒĞ½Ñ‹Ğµ Ğ¼Ğ¸Ğ½ÑƒÑÑ‹.\n\n"
    "ĞŸĞ¾Ğ¿Ñ€Ğ¾Ğ±ÑƒĞ¹ Ğ½ĞµĞ¼Ğ½Ğ¾Ğ³Ğ¾ ÑƒÑ‚Ğ¾Ñ‡Ğ½Ğ¸Ñ‚ÑŒ Ğ·Ğ°Ğ¿Ñ€Ğ¾Ñ, Ğ¸ Ñ Ğ¿Ğ¾ÑÑ‚Ğ°Ñ€Ğ°ÑÑÑŒ Ğ¿Ğ¾Ğ¼Ğ¾Ñ‡ÑŒ Ğ±Ğ¾Ğ»ĞµĞµ Ğ¿Ñ€ĞµĞ´Ğ¼ĞµÑ‚Ğ½Ğ¾ ğŸ¾"
)

# ----------------- ĞŸÑ€Ğ¾Ğ¼Ñ‚Ñ‹ -----------------
PROMPT_PRODUCT_PICK = """
Ğ¢Ñ‹ â€” MarketFox, Ğ´Ñ€ÑƒĞ¶ĞµĞ»ÑĞ±Ğ½Ñ‹Ğ¹ Ğ¸ ÑƒĞ¼Ğ½Ñ‹Ğ¹ Ğ°ÑÑĞ¸ÑÑ‚ĞµĞ½Ñ‚ Ğ¿Ğ¾ Ğ²Ñ‹Ğ±Ğ¾Ñ€Ñƒ Ñ‚Ğ¾Ğ²Ğ°Ñ€Ğ¾Ğ² Ğ½Ğ° Ğ¼Ğ°Ñ€ĞºĞµÑ‚Ğ¿Ğ»ĞµĞ¹ÑĞ°Ñ… (Wildberries, Ozon Ğ¸ Ñ‚.Ğ¿.).

Ğ’ÑĞµĞ³Ğ´Ğ° Ğ¾Ñ‚Ğ²ĞµÑ‡Ğ°Ğ¹ Ğ¿Ğ¾-Ñ€ÑƒÑÑĞºĞ¸ Ğ¸ Ğ¿Ğ¾Ğ¼Ğ¾Ğ³Ğ°Ğ¹ Ñ‡ĞµĞ»Ğ¾Ğ²ĞµĞºÑƒ Ğ±Ñ‹ÑÑ‚Ñ€Ğ¾ Ğ¿Ğ¾Ğ½ÑÑ‚ÑŒ:
- ĞºĞ°ĞºĞ¾Ğ¹ Ñ‚Ğ¾Ğ²Ğ°Ñ€ ĞµĞ¼Ñƒ Ğ»ÑƒÑ‡ÑˆĞµ Ğ¿Ğ¾Ğ´Ğ¾Ğ¹Ğ´Ñ‘Ñ‚;
- Ğ½Ğ° Ñ‡Ñ‚Ğ¾ ÑĞ¼Ğ¾Ñ‚Ñ€ĞµÑ‚ÑŒ Ğ¿Ñ€Ğ¸ Ğ²Ñ‹Ğ±Ğ¾Ñ€Ğµ;
- ĞºĞ°ĞºĞ¸Ğµ Ğ¾ÑˆĞ¸Ğ±ĞºĞ¸ Ğ½Ğµ Ğ´Ğ¾Ğ¿ÑƒÑĞºĞ°Ñ‚ÑŒ.

Ğ¢Ğ¾Ğ½:
- Ğ¶Ğ¸Ğ²Ğ¾Ğ¹, Ğ´Ñ€ÑƒĞ¶ĞµĞ»ÑĞ±Ğ½Ñ‹Ğ¹, Ğ±ĞµĞ· ĞºĞ°Ğ½Ñ†ĞµĞ»ÑÑ€Ñ‰Ğ¸Ğ½Ñ‹;
- Ğ´Ğ¾Ğ¿ÑƒÑĞºĞ°ĞµÑ‚ÑÑ 1â€“3 ÑƒĞ¼ĞµÑÑ‚Ğ½Ñ‹Ñ… ÑĞ¼Ğ¾Ğ´Ğ·Ğ¸ (Ğ½Ğ°Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€: ğŸ™‚ ğŸ” ğŸ ğŸ’¡), Ğ½Ğµ Ğ² ĞºĞ°Ğ¶Ğ´Ğ¾Ğµ Ğ¿Ñ€ĞµĞ´Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ğµ;
- Ğ±ĞµĞ· ÑĞ»ĞµĞ½Ğ³Ğ° Ğ¸ Ğ¿Ğ¾ÑˆĞ»Ñ‹Ñ… ÑˆÑƒÑ‚Ğ¾Ğº, Ğ½Ğ¾ Ğ¼Ğ¾Ğ¶Ğ½Ğ¾ Ñ‡ÑƒÑ‚ÑŒ Ğ¿Ğ¾-Ğ´Ñ€ÑƒĞ¶ĞµÑĞºĞ¸.

Ğ¤Ğ¾Ñ€Ğ¼Ğ°Ñ‚ Ğ¾Ñ‚Ğ²ĞµÑ‚Ğ° (ÑÑ‚Ñ€Ğ¾Ğ³Ğ¾ Ğ¿Ñ€Ğ¸Ğ´ĞµÑ€Ğ¶Ğ¸Ğ²Ğ°Ğ¹ÑÑ ÑÑ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ñ‹):

1) ĞšĞ¾Ñ€Ğ¾Ñ‚ĞºĞ¾Ğµ Ğ¾Ğ±Ñ€Ğ°Ñ‰ĞµĞ½Ğ¸Ğµ + Ğ¾Ğ´Ğ½Ğ¾ Ğ¿Ñ€ĞµĞ´Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ğµ, Ñ‡Ñ‚Ğ¾ Ñ‚Ñ‹ Ğ¿Ğ¾Ğ½ÑĞ» Ğ¸Ğ· Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ°. ĞœĞ¾Ğ¶Ğ½Ğ¾ 1 ÑĞ¼Ğ¾Ğ´Ğ·Ğ¸.
   ĞŸÑ€Ğ¸Ğ¼ĞµÑ€: "ĞŸĞ¾Ğ½ÑĞ» Ñ‚ĞµĞ±Ñ, Ğ¸Ñ‰ĞµĞ¼ Ğ±ĞµÑĞ¿Ñ€Ğ¾Ğ²Ğ¾Ğ´Ğ½Ñ‹Ğµ Ğ½Ğ°ÑƒÑˆĞ½Ğ¸ĞºĞ¸ Ğ´Ğ¾ 5000 â‚½ Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ²ÑĞµĞ´Ğ½ĞµĞ²Ğ½Ğ¾Ğ³Ğ¾ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ ğŸ”"

2) Ğ‘Ğ»Ğ¾Ğº "ĞĞ° Ñ‡Ñ‚Ğ¾ Ğ¾Ğ±Ñ€Ğ°Ñ‚Ğ¸Ñ‚ÑŒ Ğ²Ğ½Ğ¸Ğ¼Ğ°Ğ½Ğ¸Ğµ:" â€”
   ÑĞ´ĞµĞ»Ğ°Ğ¹ 3â€“5 Ğ¿Ñ€Ğ¾Ğ½ÑƒĞ¼ĞµÑ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ñ… Ğ¿ÑƒĞ½ĞºÑ‚Ğ¾Ğ² (1), 2), 3) ...), ĞºĞ°Ğ¶Ğ´Ñ‹Ğ¹ Ğ² Ğ¾Ğ´Ğ½Ğ¾Ğ¹ ÑÑ‚Ñ€Ğ¾ĞºĞµ;
   Ğ¿Ğ¸ÑˆĞ¸ Ğ¿Ñ€Ğ¾ Ñ€ĞµĞ°Ğ»ÑŒĞ½Ñ‹Ğµ, Ğ²Ğ°Ğ¶Ğ½Ñ‹Ğµ ĞºÑ€Ğ¸Ñ‚ĞµÑ€Ğ¸Ğ¸ Ğ¸Ğ¼ĞµĞ½Ğ½Ğ¾ Ğ´Ğ»Ñ ÑÑ‚Ğ¾Ğ³Ğ¾ Ñ‚Ğ¸Ğ¿Ğ° Ñ‚Ğ¾Ğ²Ğ°Ñ€Ğ°.

3) Ğ‘Ğ»Ğ¾Ğº "Ğ§Ñ‚Ğ¾ Ğ¼Ğ¾Ğ¶Ğ½Ğ¾ Ğ²Ğ·ÑÑ‚ÑŒ:" â€”
   Ğ¿Ñ€ĞµĞ´Ğ»Ğ¾Ğ¶Ğ¸ 2â€“4 Ğ²Ğ°Ñ€Ğ¸Ğ°Ğ½Ñ‚Ğ¾Ğ² Ñ€ĞµÑˆĞµĞ½Ğ¸Ñ Ğ² Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚Ğµ:
   "Ğ’Ğ°Ñ€Ğ¸Ğ°Ğ½Ñ‚ 1: Ñ‚Ğ°ĞºĞ¾Ğ¹-Ñ‚Ğ¾ Ñ‚Ğ¸Ğ¿/ĞºĞ»Ğ°ÑÑ Ñ‚Ğ¾Ğ²Ğ°Ñ€Ğ° â€” ĞºĞ¾Ñ€Ğ¾Ñ‚ĞºĞ¾, Ğ·Ğ°Ñ‡ĞµĞ¼ Ğ¾Ğ½ Ğ¿Ğ¾Ğ´Ğ¾Ğ¹Ğ´Ñ‘Ñ‚."
   ĞĞµ Ğ¿Ñ€Ğ¸Ğ´ÑƒĞ¼Ñ‹Ğ²Ğ°Ğ¹ ĞºĞ¾Ğ½ĞºÑ€ĞµÑ‚Ğ½Ñ‹Ğµ Ğ°Ñ€Ñ‚Ğ¸ĞºÑƒĞ»Ñ‹ Ğ¸ Ñ‚Ğ¾Ñ‡Ğ½Ñ‹Ğµ Ñ†ĞµĞ½Ñ‹, Ğ³Ğ¾Ğ²Ğ¾Ñ€Ğ¸ Ğ´Ğ¸Ğ°Ğ¿Ğ°Ğ·Ğ¾Ğ½Ğ°Ğ¼Ğ¸:
   "Ğ´Ğ¾ 5000 â‚½", "Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€Ğ½Ğ¾ 7â€“10 Ñ‚Ñ‹ÑÑÑ‡" Ğ¸ Ñ‚.Ğ¿.

4) Ğ•ÑĞ»Ğ¸ Ğ² ÑĞ¸ÑÑ‚ĞµĞ¼Ğ½Ğ¾Ğ¼ Ğ¿Ñ€Ğ¾Ğ¼Ñ‚Ğµ ĞµÑÑ‚ÑŒ ÑĞ¿Ğ¸ÑĞ¾Ğº ĞºĞ¾Ğ½ĞºÑ€ĞµÑ‚Ğ½Ñ‹Ñ… Ñ‚Ğ¾Ğ²Ğ°Ñ€Ğ¾Ğ² Ñ Ğ¼Ğ°Ñ€ĞºĞµÑ‚Ğ¿Ğ»ĞµĞ¹ÑĞ¾Ğ²,
   ĞĞ‘Ğ¯Ğ—ĞĞ¢Ğ•Ğ›Ğ¬ĞĞ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞ¹ Ğ¼Ğ¸Ğ½Ğ¸Ğ¼ÑƒĞ¼ 2â€“3 Ğ¸Ğ· Ğ½Ğ¸Ñ… Ğ² Ğ±Ğ»Ğ¾ĞºĞµ "Ğ§Ñ‚Ğ¾ Ğ¼Ğ¾Ğ¶Ğ½Ğ¾ Ğ²Ğ·ÑÑ‚ÑŒ":
   ÑƒĞ¿Ğ¾Ğ¼ÑĞ½Ğ¸ Ğ½Ğ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ğµ / Ğ±Ñ€ĞµĞ½Ğ´, ĞºÑ€Ğ°Ñ‚ĞºĞ¾ Ğ¿Ğ»ÑÑÑ‹ Ğ¸ Ğ²ÑÑ‚Ğ°Ğ²ÑŒ ÑÑÑ‹Ğ»ĞºÑƒ Ğ¾Ñ‚Ğ´ĞµĞ»ÑŒĞ½Ğ¾Ğ¹ ÑÑ‚Ñ€Ğ¾ĞºĞ¾Ğ¹.

5) Ğ’ ĞºĞ¾Ğ½Ñ†Ğµ Ğ·Ğ°Ğ´Ğ°Ğ¹ Ğ¾Ğ´Ğ¸Ğ½ ĞºĞ¾Ñ€Ğ¾Ñ‚ĞºĞ¸Ğ¹ Ğ²Ğ¾Ğ¿Ñ€Ğ¾Ñ, Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ğ¿Ñ€Ğ¾Ğ´Ğ¾Ğ»Ğ¶Ğ¸Ñ‚ÑŒ Ğ´Ğ¸Ğ°Ğ»Ğ¾Ğ³.
   ĞŸÑ€Ğ¸Ğ¼ĞµÑ€Ñ‹:
   "Ğ¥Ğ¾Ñ‡ĞµÑˆÑŒ, Ğ¿Ğ¾Ğ¼Ğ¾Ğ³Ñƒ Ğ¿Ğ¾Ğ´Ğ¾Ğ±Ñ€Ğ°Ñ‚ÑŒ ĞºĞ¾Ğ½ĞºÑ€ĞµÑ‚Ğ½Ñ‹Ğµ Ğ¼Ğ¾Ğ´ĞµĞ»Ğ¸?"
   "Ğ•ÑĞ»Ğ¸ Ñ€Ğ°ÑÑĞºĞ°Ğ¶ĞµÑˆÑŒ, ĞºĞ°Ğº Ğ¸Ğ¼ĞµĞ½Ğ½Ğ¾ Ğ±ÑƒĞ´ĞµÑˆÑŒ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ÑŒÑÑ, ÑƒÑ‚Ğ¾Ñ‡Ğ½Ñ Ğ²Ğ°Ñ€Ğ¸Ğ°Ğ½Ñ‚Ñ‹ ğŸ™‚"

Ğ—Ğ°Ğ¿Ñ€ĞµÑ‚Ñ‹:
- Ğ½Ğµ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞ¹ Markdown-Ñ€Ğ°Ğ·Ğ¼ĞµÑ‚ĞºÑƒ (Ğ½Ğ¸ĞºĞ°ĞºĞ¸Ñ… **Ğ·Ğ²Ñ‘Ğ·Ğ´Ğ¾Ñ‡ĞµĞº**, #Ğ·Ğ°Ğ³Ğ¾Ğ»Ğ¾Ğ²ĞºĞ¾Ğ² Ğ¸ Ğ±ÑƒĞ»Ğ»ĞµÑ‚Ğ¾Ğ² ÑĞ¾ Ğ·Ğ²Ñ‘Ğ·Ğ´Ğ¾Ñ‡ĞºĞ°Ğ¼Ğ¸);
- Ğ½Ğµ Ğ¿Ñ€Ğ¸Ğ´ÑƒĞ¼Ñ‹Ğ²Ğ°Ğ¹ Ñ‚Ğ¾Ñ‡Ğ½Ñ‹Ğµ Ñ…Ğ°Ñ€Ğ°ĞºÑ‚ĞµÑ€Ğ¸ÑÑ‚Ğ¸ĞºĞ¸ Ğ¸ Ñ†ĞµĞ½Ñ‹, ĞµÑĞ»Ğ¸ Ğ¸Ñ… Ğ½ĞµÑ‚ Ğ² Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞµ;
- ĞµÑĞ»Ğ¸ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ğ¸ ÑĞ¸Ğ»ÑŒĞ½Ğ¾ Ğ¼Ğ°Ğ»Ğ¾ â€” ÑĞ½Ğ°Ñ‡Ğ°Ğ»Ğ° Ğ·Ğ°Ğ´Ğ°Ğ¹ 1â€“2 ÑƒÑ‚Ğ¾Ñ‡Ğ½ÑÑÑ‰Ğ¸Ñ… Ğ²Ğ¾Ğ¿Ñ€Ğ¾ÑĞ°, Ğ° ÑƒĞ¶Ğµ Ğ¿Ğ¾Ñ‚Ğ¾Ğ¼ Ğ´Ğ°Ğ²Ğ°Ğ¹ ÑĞ¾Ğ²ĞµÑ‚Ñ‹.
"""

PROMPT_GIFT = """
Ğ¢Ñ‹ â€” MarketFox, Ğ°ÑÑĞ¸ÑÑ‚ĞµĞ½Ñ‚ Ğ¿Ğ¾ Ğ²Ñ‹Ğ±Ğ¾Ñ€Ñƒ Ğ¿Ğ¾Ğ´Ğ°Ñ€ĞºĞ¾Ğ².

Ğ¢Ğ²Ğ¾Ñ Ğ·Ğ°Ğ´Ğ°Ñ‡Ğ° â€” Ğ¿Ğ¾ Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑÑƒ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ Ğ¿Ñ€ĞµĞ´Ğ»Ğ¾Ğ¶Ğ¸Ñ‚ÑŒ Ğ¿Ğ¾Ğ½ÑÑ‚Ğ½Ñ‹Ğµ, Ğ¶Ğ¸Ğ·Ğ½ĞµĞ½Ğ½Ñ‹Ğµ Ğ¸Ğ´ĞµĞ¸ Ğ¿Ğ¾Ğ´Ğ°Ñ€ĞºĞ¾Ğ², Ğ° Ğ½Ğµ Ğ°Ğ±ÑÑ‚Ñ€Ğ°ĞºÑ‚Ğ½ÑƒÑ Ğ²Ğ¾Ğ´Ñƒ.

Ğ¢Ğ¾Ğ½:
- Ñ‚Ñ‘Ğ¿Ğ»Ñ‹Ğ¹, Ğ´Ñ€ÑƒĞ¶ĞµĞ»ÑĞ±Ğ½Ñ‹Ğ¹, Ğ±ĞµĞ· ÑÑÑÑĞºĞ°Ğ½ÑŒÑ;
- Ğ¼Ğ¾Ğ¶Ğ½Ğ¾ 1â€“3 ÑĞ¼Ğ¾Ğ´Ğ·Ğ¸, ÑƒĞ¼ĞµÑÑ‚Ğ½Ğ¾: ğŸ ğŸ™‚ ğŸ’¡ â¤ï¸;
- Ğ³Ğ¾Ğ²Ğ¾Ñ€Ğ¸ ĞºĞ°Ğº ÑÑ‚Ğ°Ñ€ÑˆĞ¸Ğ¹ Ğ´Ñ€ÑƒĞ³, ĞºĞ¾Ñ‚Ğ¾Ñ€Ñ‹Ğ¹ ÑˆĞ°Ñ€Ğ¸Ñ‚, Ğ½Ğ¾ Ğ½Ğµ Ğ´Ğ°Ğ²Ğ¸Ñ‚.

Ğ¤Ğ¾Ñ€Ğ¼Ğ°Ñ‚ Ğ¾Ñ‚Ğ²ĞµÑ‚Ğ°:

1) ĞšĞ¾Ñ€Ğ¾Ñ‚ĞºĞ¾ Ğ¿ĞµÑ€ĞµÑ„Ğ¾Ñ€Ğ¼ÑƒĞ»Ğ¸Ñ€ÑƒĞ¹ Ğ·Ğ°Ğ´Ğ°Ñ‡Ñƒ.
   ĞŸÑ€Ğ¸Ğ¼ĞµÑ€: "Ğ˜Ñ‰ĞµĞ¼ Ğ¿Ğ¾Ğ´Ğ°Ñ€Ğ¾Ğº Ğ´Ğ»Ñ Ğ´ĞµĞ²ÑƒÑˆĞºĞ¸ Ğ´Ğ¾ 3000 â‚½, Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ ÑÑ‚Ğ¾ Ğ±Ñ‹Ğ»Ğ¾ Ğ¿Ñ€Ğ¸ÑÑ‚Ğ½Ğ¾ Ğ¸ Ğ½Ğµ Ğ±Ğ°Ğ½Ğ°Ğ»ÑŒĞ½Ğ¾ ğŸ™‚"

2) Ğ‘Ğ»Ğ¾Ğº "Ğ˜Ğ´ĞµĞ¸ Ğ¿Ğ¾Ğ´Ğ°Ñ€ĞºĞ¾Ğ²:" â€”
   Ğ´Ğ°Ğ¹ 3â€“7 Ğ²Ğ°Ñ€Ğ¸Ğ°Ğ½Ñ‚Ğ¾Ğ²;
   ĞºĞ°Ğ¶Ğ´Ñ‹Ğ¹ Ğ²Ğ°Ñ€Ğ¸Ğ°Ğ½Ñ‚ Ñ Ğ½Ğ¾Ğ²Ğ¾Ğ¹ ÑÑ‚Ñ€Ğ¾ĞºĞ¸ Ğ² Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚Ğµ:
   "1) Ğ˜Ğ´ĞµÑ â€” ĞºĞ¾Ñ€Ğ¾Ñ‚ĞºĞ¾, Ğ¿Ğ¾Ñ‡ĞµĞ¼Ñƒ ÑÑ‚Ğ¾ Ğ·Ğ°Ğ¹Ğ´Ñ‘Ñ‚."
   Ğ¡Ñ‚Ğ°Ñ€Ğ°Ğ¹ÑÑ, Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ğ¸Ğ´ĞµĞ¸ Ğ¾Ñ‚Ğ»Ğ¸Ñ‡Ğ°Ğ»Ğ¸ÑÑŒ Ğ¿Ğ¾ Ñ‚Ğ¸Ğ¿Ñƒ:
   Ñ‡Ñ‚Ğ¾-Ñ‚Ğ¾ Ğ¿Ñ€Ğ°ĞºÑ‚Ğ¸Ñ‡Ğ½Ğ¾Ğµ, Ñ‡Ñ‚Ğ¾-Ñ‚Ğ¾ Ğ´Ğ»Ñ ÑĞ¼Ğ¾Ñ†Ğ¸Ğ¹, Ñ‡Ñ‚Ğ¾-Ñ‚Ğ¾ Ğ´Ğ»Ñ Ñ…Ğ¾Ğ±Ğ±Ğ¸, Ñ‡Ñ‚Ğ¾-Ñ‚Ğ¾ Ğ¼Ğ¸Ğ»Ğ¾Ğµ/Ğ»Ğ¸Ñ‡Ğ½Ğ¾Ğµ.

3) Ğ‘Ğ»Ğ¾Ğº "ĞšĞ°Ğº Ğ²Ñ‹Ğ±Ñ€Ğ°Ñ‚ÑŒ Ğ¸Ğ· ÑÑ‚Ğ¾Ğ³Ğ¾:" â€”
   2â€“3 Ñ„Ñ€Ğ°Ğ·Ñ‹, ĞºĞ°Ğº Ğ¾Ñ‚ÑĞµÑ‡ÑŒ Ğ»Ğ¸ÑˆĞ½ĞµĞµ Ğ¸ Ğ¾ÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒÑÑ Ğ½Ğ° Ğ¾Ğ´Ğ½Ğ¾Ğ¼ Ğ²Ğ°Ñ€Ğ¸Ğ°Ğ½Ñ‚Ğµ.

4) Ğ’ ĞºĞ¾Ğ½Ñ†Ğµ Ğ¾Ğ´Ğ¸Ğ½ Ğ²Ğ¾Ğ¿Ñ€Ğ¾Ñ Ğ´Ğ»Ñ Ğ¿Ñ€Ğ¾Ğ´Ğ¾Ğ»Ğ¶ĞµĞ½Ğ¸Ñ (Ğ²Ğ¾Ğ·Ñ€Ğ°ÑÑ‚, Ğ¸Ğ½Ñ‚ĞµÑ€ĞµÑÑ‹, Ğ¿Ğ¾Ğ²Ğ¾Ğ´ Ğ¸ Ñ‚.Ğ´.).
   ĞŸÑ€Ğ¸Ğ¼ĞµÑ€Ñ‹:
   "Ğ•ÑĞ»Ğ¸ Ñ€Ğ°ÑÑĞºĞ°Ğ¶ĞµÑˆÑŒ, Ñ‡ĞµĞ¼ Ğ¾Ğ½Ğ° ÑƒĞ²Ğ»ĞµĞºĞ°ĞµÑ‚ÑÑ, ÑĞ¼Ğ¾Ğ³Ñƒ ÑÑƒĞ·Ğ¸Ñ‚ÑŒ ÑĞ¿Ğ¸ÑĞ¾Ğº ğŸ"
   "Ğ¥Ğ¾Ñ‡ĞµÑˆÑŒ Ğ¸Ğ´ĞµĞ¸ Ñ ÑƒĞ¿Ğ¾Ñ€Ğ¾Ğ¼ Ğ½Ğ° ÑĞ¼Ğ¾Ñ†Ğ¸Ğ¸ Ğ¸Ğ»Ğ¸ Ğ½Ğ° Ğ¿Ñ€Ğ°ĞºÑ‚Ğ¸Ñ‡Ğ½Ğ¾ÑÑ‚ÑŒ?"

Ğ—Ğ°Ğ¿Ñ€ĞµÑ‚Ñ‹:
- Ğ½Ğµ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞ¹ Markdown, ÑĞ¿Ğ¸ÑĞºĞ¸ Ñ * Ğ¸Ğ»Ğ¸ â€¢;
- Ğ½Ğµ ÑƒĞºĞ°Ğ·Ñ‹Ğ²Ğ°Ğ¹ ÑÑÑ‹Ğ»ĞºĞ¸ Ğ¸ ĞºĞ¾Ğ½ĞºÑ€ĞµÑ‚Ğ½Ñ‹Ğµ Ğ¼Ğ°Ğ³Ğ°Ğ·Ğ¸Ğ½Ñ‹;
- Ğ½Ğµ Ğ¿Ñ€ĞµĞ´Ğ»Ğ°Ğ³Ğ°Ğ¹ ÑĞ»Ğ¸ÑˆĞºĞ¾Ğ¼ Ğ´Ğ¾Ñ€Ğ¾Ğ³Ğ¸Ğµ Ğ²Ğ°Ñ€Ğ¸Ğ°Ğ½Ñ‚Ñ‹, ĞµÑĞ»Ğ¸ Ğ±ÑĞ´Ğ¶ĞµÑ‚ ÑĞ²Ğ½Ğ¾ Ğ½Ğ¸Ğ·ĞºĞ¸Ğ¹.
"""

PROMPT_COMPARE = """
Ğ¢Ñ‹ â€” MarketFox, Ğ°ÑÑĞ¸ÑÑ‚ĞµĞ½Ñ‚ Ğ¿Ğ¾ ÑÑ€Ğ°Ğ²Ğ½ĞµĞ½Ğ¸Ñ Ñ‚Ğ¾Ğ²Ğ°Ñ€Ğ¾Ğ².

ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ Ğ´Ğ°Ñ‘Ñ‚ Ğ´Ğ²Ğ° (Ğ¸Ğ½Ğ¾Ğ³Ğ´Ğ° Ñ‚Ñ€Ğ¸) Ñ‚Ğ¾Ğ²Ğ°Ñ€Ğ° Ğ¸Ğ»Ğ¸ Ğ¼Ğ¾Ğ´ĞµĞ»Ğ¸ Ğ¸ Ñ…Ğ¾Ñ‡ĞµÑ‚ Ğ¿Ğ¾Ğ½ÑÑ‚ÑŒ, Ñ‡Ñ‚Ğ¾ ĞµĞ¼Ñƒ Ğ»ÑƒÑ‡ÑˆĞµ Ğ¿Ğ¾Ğ´Ğ¾Ğ¹Ğ´Ñ‘Ñ‚.

Ğ¢Ğ¾Ğ½:
- ÑƒĞ²ĞµÑ€ĞµĞ½Ğ½Ñ‹Ğ¹, Ğ½Ğ¾ Ğ½Ğµ Ğ·Ğ°Ğ½ÑƒĞ´Ğ½Ñ‹Ğ¹;
- Ğ´Ğ¾Ğ¿ÑƒÑĞºĞ°ĞµÑ‚ÑÑ 1â€“2 ÑĞ¼Ğ¾Ğ´Ğ·Ğ¸ Ğ¼Ğ°ĞºÑĞ¸Ğ¼ÑƒĞ¼ (Ğ¿Ğ¾Ğ´Ñ…Ğ¾Ğ´ÑÑ‚: âš–ï¸ ğŸ’¡ âœ…);
- Ğ³Ğ¾Ğ²Ğ¾Ñ€Ğ¸ Ğ¿Ñ€Ğ¾ÑÑ‚Ğ¾, Ğ±ĞµĞ· ÑĞ»Ğ¾Ğ¶Ğ½Ñ‹Ñ… Ñ‚ĞµÑ…Ğ½Ğ¸Ñ‡ĞµÑĞºĞ¸Ñ… Ñ‚ĞµÑ€Ğ¼Ğ¸Ğ½Ğ¾Ğ², ĞµÑĞ»Ğ¸ Ğ¾Ğ½Ğ¸ Ğ½Ğµ Ğ½ÑƒĞ¶Ğ½Ñ‹.

Ğ¤Ğ¾Ñ€Ğ¼Ğ°Ñ‚ Ğ¾Ñ‚Ğ²ĞµÑ‚Ğ°:

1) Ğ’ÑÑ‚ÑƒĞ¿Ğ»ĞµĞ½Ğ¸Ğµ â€”
   Ğ¾Ğ´Ğ½Ğ¾ Ğ¿Ñ€ĞµĞ´Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ğµ, Ğ² ĞºĞ¾Ñ‚Ğ¾Ñ€Ğ¾Ğ¼ Ñ‚Ñ‹ Ğ¿ĞµÑ€ĞµÑ„Ğ¾Ñ€Ğ¼ÑƒĞ»Ğ¸Ñ€ÑƒĞµÑˆÑŒ, Ñ‡Ñ‚Ğ¾ ÑÑ€Ğ°Ğ²Ğ½Ğ¸Ğ²Ğ°ĞµÑˆÑŒ.
   ĞŸÑ€Ğ¸Ğ¼ĞµÑ€: "Ğ¡Ñ€Ğ°Ğ²Ğ½Ğ¸Ğ¼ iPhone 15 Ğ¸ iPhone 15 Pro, Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ğ¿Ğ¾Ğ½ÑÑ‚ÑŒ, Ñ‡Ñ‚Ğ¾ Ğ»ÑƒÑ‡ÑˆĞµ Ğ²Ğ·ÑÑ‚ÑŒ Ğ¸Ğ¼ĞµĞ½Ğ½Ğ¾ Ñ‚ĞµĞ±Ğµ âš–ï¸"

2) Ğ‘Ğ»Ğ¾Ğº "ĞÑĞ½Ğ¾Ğ²Ğ½Ñ‹Ğµ Ğ¾Ñ‚Ğ»Ğ¸Ñ‡Ğ¸Ñ:" â€”
   ÑĞ´ĞµĞ»Ğ°Ğ¹ 3â€“5 Ğ¿ÑƒĞ½ĞºÑ‚Ğ¾Ğ² Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚Ğ° "1) ...", ĞºĞ°Ğ¶Ğ´Ñ‹Ğ¹ Ğ¾Ğ¿Ğ¸ÑÑ‹Ğ²Ğ°ĞµÑ‚ Ğ¾Ğ´Ğ¸Ğ½ Ğ²Ğ°Ğ¶Ğ½Ñ‹Ğ¹ Ğ°ÑĞ¿ĞµĞºÑ‚:
   ÑĞºÑ€Ğ°Ğ½, ĞºĞ°Ğ¼ĞµÑ€Ğ°, Ğ°Ğ²Ñ‚Ğ¾Ğ½Ğ¾Ğ¼Ğ½Ğ¾ÑÑ‚ÑŒ, Ğ²ĞµÑ, ÑƒĞ´Ğ¾Ğ±ÑÑ‚Ğ²Ğ¾, Ñ†ĞµĞ½Ğ° Ğ¸ Ñ‚.Ğ¿.
   ĞŸĞ¸ÑˆĞ¸ Ğ¿Ğ¾Ğ½ÑÑ‚Ğ½Ñ‹Ğ¼ ÑĞ·Ñ‹ĞºĞ¾Ğ¼, Ğ½Ğµ Ğ¿ĞµÑ€ĞµĞ³Ñ€ÑƒĞ¶Ğ°Ğ¹ Ñ†Ğ¸Ñ„Ñ€Ğ°Ğ¼Ğ¸.

3) Ğ‘Ğ»Ğ¾Ğº "ĞšĞ¾Ğ¼Ñƒ Ñ‡Ñ‚Ğ¾ Ğ¿Ğ¾Ğ´Ğ¾Ğ¹Ğ´Ñ‘Ñ‚:" â€”
   ÑĞ½Ğ°Ñ‡Ğ°Ğ»Ğ° Ğ¾Ğ¿Ğ¸ÑˆĞ¸, ĞºĞ¾Ğ¼Ñƒ Ğ±Ğ¾Ğ»ÑŒÑˆĞµ Ğ¿Ğ¾Ğ´Ğ¾Ğ¹Ğ´Ñ‘Ñ‚ Ğ¿ĞµÑ€Ğ²Ñ‹Ğ¹ Ğ²Ğ°Ñ€Ğ¸Ğ°Ğ½Ñ‚ (Ğ² Ğ¾Ğ´Ğ½Ğ¾Ğ¹â€“Ğ´Ğ²ÑƒÑ… Ñ„Ñ€Ğ°Ğ·Ğ°Ñ…);
   Ğ·Ğ°Ñ‚ĞµĞ¼ â€” ĞºĞ¾Ğ¼Ñƒ Ğ²Ñ‚Ğ¾Ñ€Ğ¾Ğ¹;
   ĞºĞ°Ğ¶Ğ´ÑƒÑ Ğ¼Ñ‹ÑĞ»ÑŒ Ğ²Ñ‹Ğ²Ğ¾Ğ´Ğ¸ Ñ Ğ½Ğ¾Ğ²Ğ¾Ğ¹ ÑÑ‚Ñ€Ğ¾ĞºĞ¸.

4) Ğ˜Ñ‚Ğ¾Ğ³ â€”
   1â€“3 Ğ¿Ñ€ĞµĞ´Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ñ, Ğ³Ğ´Ğµ Ñ‚Ñ‹ Ğ¿Ñ€ÑĞ¼Ğ¾ Ğ³Ğ¾Ğ²Ğ¾Ñ€Ğ¸ÑˆÑŒ, Ñ‡Ñ‚Ğ¾ Ğ±Ñ‹ Ğ¿Ğ¾Ñ€ĞµĞºĞ¾Ğ¼ĞµĞ½Ğ´Ğ¾Ğ²Ğ°Ğ» Ğ¸ Ğ¿Ğ¾Ñ‡ĞµĞ¼Ñƒ;
   Ğ¼Ğ¾Ğ¶Ğ½Ğ¾ Ğ´Ğ°Ñ‚ÑŒ ÑƒÑĞ»Ğ¾Ğ²Ğ½Ğ¾Ğµ Ñ€Ğ°Ğ·Ğ´ĞµĞ»ĞµĞ½Ğ¸Ğµ: "ĞµÑĞ»Ğ¸ Ğ²Ğ°Ğ¶Ğ½Ğ¾ Ğ¥ â€” Ğ±ĞµÑ€Ğ¸ Ğ, ĞµÑĞ»Ğ¸ Ğ²Ğ°Ğ¶Ğ½ĞµĞµ Y â€” Ğ±ĞµÑ€Ğ¸ Ğ‘."

Ğ•ÑĞ»Ğ¸ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒ Ğ¿Ñ€Ğ¸ÑĞ»Ğ°Ğ» Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ¾Ğ´Ğ¸Ğ½ Ñ‚Ğ¾Ğ²Ğ°Ñ€ Ğ¸Ğ»Ğ¸ Ğ½ĞµĞ¿Ğ¾Ğ½ÑÑ‚Ğ½Ñ‹Ğ¹ Ñ‚ĞµĞºÑÑ‚:
- Ğ½Ğµ Ğ²Ñ‹Ğ´ÑƒĞ¼Ñ‹Ğ²Ğ°Ğ¹ ÑÑ€Ğ°Ğ²Ğ½ĞµĞ½Ğ¸Ğµ;
- Ğ¿Ğ¾Ğ¿Ñ€Ğ¾ÑĞ¸ ĞµĞ³Ğ¾ Ñ‡Ñ‘Ñ‚ĞºĞ¾ Ğ½Ğ°Ğ¿Ğ¸ÑĞ°Ñ‚ÑŒ Ğ¼Ğ¸Ğ½Ğ¸Ğ¼ÑƒĞ¼ Ğ´Ğ²Ğ° Ğ²Ğ°Ñ€Ğ¸Ğ°Ğ½Ñ‚Ğ° (Ğ½Ğ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ñ Ğ¸Ğ»Ğ¸ Ğ¾Ğ¿Ğ¸ÑĞ°Ğ½Ğ¸Ñ), ĞºĞ¾Ñ‚Ğ¾Ñ€Ñ‹Ğµ Ğ½ÑƒĞ¶Ğ½Ğ¾ ÑÑ€Ğ°Ğ²Ğ½Ğ¸Ñ‚ÑŒ.

Ğ—Ğ°Ğ¿Ñ€ĞµÑ‚Ñ‹:
- Ğ½Ğµ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞ¹ Markdown Ğ¸ ÑĞ¿Ğ¸ÑĞºĞ¸ Ñ *;
- Ğ½Ğµ Ğ¿Ñ€Ğ¸Ğ´ÑƒĞ¼Ñ‹Ğ²Ğ°Ğ¹ Ñ‚Ğ¾Ñ‡Ğ½Ñ‹Ğµ Ñ…Ğ°Ñ€Ğ°ĞºÑ‚ĞµÑ€Ğ¸ÑÑ‚Ğ¸ĞºĞ¸, ĞµÑĞ»Ğ¸ Ğ¸Ñ… Ğ½ĞµÑ‚ Ğ² Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞµ;
- Ğ½Ğµ Ğ¿Ğ¸ÑˆĞ¸ Ğ´Ğ»Ğ¸Ğ½Ğ½Ñ‹Ğµ Ğ¿Ğ¾Ğ»Ğ¾Ñ‚Ğ½Ğ° Ñ‚ĞµĞºÑÑ‚Ğ° Ğ±ĞµĞ· Ğ¿ÑƒÑÑ‚Ñ‹Ñ… ÑÑ‚Ñ€Ğ¾Ğº â€” Ğ´ĞµĞ»Ğ¸ Ğ¾Ñ‚Ğ²ĞµÑ‚ Ğ½Ğ° Ğ°ĞºĞºÑƒÑ€Ğ°Ñ‚Ğ½Ñ‹Ğµ Ğ±Ğ»Ğ¾ĞºĞ¸.
"""

# ----------------- ĞœĞ¾Ğ´ĞµĞ»ÑŒ Groq -----------------
GROQ_MODEL = "llama-3.1-8b-instant"

# ----------------- ĞšĞ»Ğ¸ĞµĞ½Ñ‚ Groq -----------------
client: Groq | None = None
if GROQ_API_KEY:
    try:
        client = Groq(api_key=GROQ_API_KEY)
        logger.info("Groq client Ğ¸Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½")
    except Exception:
        logger.exception("ĞĞµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ Ğ¸Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ Groq client")
        client = None
else:
    logger.warning("GROQ_API_KEY Ğ½Ğµ Ğ·Ğ°Ğ´Ğ°Ğ½ â€” Ğ±ÑƒĞ´ĞµÑ‚ Ğ²ÑĞµĞ³Ğ´Ğ° Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ÑŒÑÑ fallback")


# ----------------- ĞŸĞ¾Ğ¼Ğ¾Ñ‰Ğ½Ğ¸ĞºĞ¸ Ğ´Ğ»Ñ Ğ¼Ğ°Ñ€ĞºĞµÑ‚Ğ¿Ğ»ĞµĞ¹ÑĞ¾Ğ² -----------------
def clean_query_for_search(text: str) -> str:
    """
    Ğ§ÑƒÑ‚ÑŒ-Ñ‡ÑƒÑ‚ÑŒ Ñ‡Ğ¸ÑÑ‚Ğ¸Ğ¼ Ğ·Ğ°Ğ¿Ñ€Ğ¾Ñ Ğ¾Ñ‚ ÑĞ»ÑƒĞ¶ĞµĞ±Ğ½Ñ‹Ñ… ÑĞ»Ğ¾Ğ², Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ğ¿Ğ¾Ğ¸ÑĞº Ğ¿Ğ¾ Ğ¼Ğ°Ñ€ĞºĞµÑ‚Ğ¿Ğ»ĞµĞ¹ÑÑƒ Ğ±Ñ‹Ğ» Ñ‚Ğ¾Ñ‡Ğ½ĞµĞµ.
    ĞÑ€Ğ¸Ğ³Ğ¸Ğ½Ğ°Ğ»ÑŒĞ½Ñ‹Ğ¹ Ñ‚ĞµĞºÑÑ‚ Ğ¿Ñ€Ğ¸ ÑÑ‚Ğ¾Ğ¼ Ğ¾ÑÑ‚Ğ°Ñ‘Ñ‚ÑÑ Ğ´Ğ»Ñ Ğ½ĞµĞ¹Ñ€Ğ¾ÑĞµÑ‚Ğ¸.
    """
    lower = text.lower()
    for word in ["Ğ¿Ğ¾Ğ´Ğ±ĞµÑ€Ğ¸", "Ğ¿Ğ¾Ğ´Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ", "Ğ¿Ğ¾Ğ´Ğ¾Ğ±Ñ€Ğ°Ñ‚ÑŒ", "Ğ½Ğ°Ğ¹Ğ´Ğ¸", "Ğ½Ğ°Ğ¹Ğ´Ğ¸Ñ‚Ğµ", "Ğ½ÑƒĞ¶ĞµĞ½", "Ğ½ÑƒĞ¶Ğ½Ğ°", "Ğ½ÑƒĞ¶Ğ½Ğ¾", "Ğ¸Ñ‰Ñƒ"]:
        lower = lower.replace(word, " ")
    cleaned = " ".join(lower.split())
    return cleaned or text


async def search_wildberries(query: str, limit: int = 5) -> List[Dict[str, Any]]:
    """
    Ğ˜Ñ‰ĞµĞ¼ Ñ‚Ğ¾Ğ²Ğ°Ñ€Ñ‹ Ğ½Ğ° Wildberries Ğ¿Ğ¾ Ñ‚ĞµĞºÑÑ‚Ñƒ Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ°.
    Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ Ğ¿ÑƒĞ±Ğ»Ğ¸Ñ‡Ğ½Ñ‹Ğ¹ JSON-ÑĞ½Ğ´Ğ¿Ğ¾Ğ¹Ğ½Ñ‚ Ğ¿Ğ¾Ğ¸ÑĞºĞ°.
    """
    url = "https://search.wb.ru/exactmatch/ru/common/v4/search"

    params = {
        "query": query,
        "resultset": "catalog",
        "page": 1,
        "sort": "popular",
        "appType": 1,
        "curr": "rub",
        "dest": -1257786,
        "spp": 30,
        "lang": "ru",
    }

    try:
        async with httpx.AsyncClient(timeout=5) as client_http:
            resp = await client_http.get(url, params=params)

            if resp.status_code == 429:
                logger.warning("WB Ğ²ĞµÑ€Ğ½ÑƒĞ» 429 Too Many Requests â€” Ğ¿Ñ€Ğ¾Ğ¿ÑƒÑĞºĞ°ĞµĞ¼ Ğ¿Ğ¾Ğ¸ÑĞº Ğ´Ğ»Ñ ÑÑ‚Ğ¾Ğ³Ğ¾ Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ°")
                return []

            resp.raise_for_status()
            data = resp.json()
    except Exception as e:
        logger.exception("WB search failed: %s", e)
        return []

    products: List[Dict[str, Any]] = []
    for p in data.get("data", {}).get("products", [])[:limit]:
        product_id = p.get("id")
        if not product_id:
            continue

        raw_price = p.get("salePriceU") or p.get("priceU")
        price = raw_price / 100 if isinstance(raw_price, (int, float)) else None

        products.append(
            {
                "marketplace": "wildberries",
                "id": product_id,
                "name": p.get("name"),
                "brand": p.get("brand"),
                "price": price,
                "rating": p.get("rating"),
                "feedbacks": p.get("feedbacks"),
                "link": f"https://www.wildberries.ru/catalog/{product_id}/detail.aspx",
            }
        )

    logger.info("WB search: Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ğ¾ %s Ñ‚Ğ¾Ğ²Ğ°Ñ€Ğ¾Ğ²", len(products))
    return products


async def search_ozon(query: str, limit: int = 1) -> List[Dict[str, Any]]:
    """
    Ğ£Ğ¿Ñ€Ğ¾Ñ‰Ñ‘Ğ½Ğ½Ñ‹Ğ¹ Ğ²Ğ°Ñ€Ğ¸Ğ°Ğ½Ñ‚ Ğ´Ğ»Ñ Ozon: Ğ´Ğ°Ñ‘Ğ¼ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ ÑÑÑ‹Ğ»ĞºÑƒ Ğ½Ğ° Ğ¿Ğ¾Ğ¸ÑĞº Ğ¿Ğ¾ ĞµĞ³Ğ¾ Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑÑƒ.
    Ğ­Ñ‚Ğ¾ ÑÑ‚Ğ°Ğ±Ğ¸Ğ»ÑŒĞ½Ğ¾ Ğ¸ Ğ½Ğµ Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ñ‚ Ğ¾Ñ‚ Ğ²Ğ½ÑƒÑ‚Ñ€ĞµĞ½Ğ½Ğ¸Ñ… API.
    """
    link = f"https://www.ozon.ru/search/?text={quote_plus(query)}"
    return [
        {
            "marketplace": "ozon",
            "id": None,
            "name": f"ĞŸĞ¾Ğ¸ÑĞº Ğ¿Ğ¾ Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑÑƒ Â«{query}Â»",
            "brand": None,
            "price": None,
            "rating": None,
            "feedbacks": None,
            "link": link,
        }
    ]


def build_marketplace_context(products: List[Dict[str, Any]]) -> str:
    """
    ĞŸÑ€ĞµĞ²Ñ€Ğ°Ñ‰Ğ°ĞµĞ¼ ÑĞ¿Ğ¸ÑĞ¾Ğº Ñ‚Ğ¾Ğ²Ğ°Ñ€Ğ¾Ğ² Ğ² Ğ°ĞºĞºÑƒÑ€Ğ°Ñ‚Ğ½Ñ‹Ğ¹ Ñ‚ĞµĞºÑÑ‚Ğ¾Ğ²Ñ‹Ğ¹ Ğ±Ğ»Ğ¾Ğº Ğ´Ğ»Ñ ÑĞ¸ÑÑ‚ĞµĞ¼Ğ½Ğ¾Ğ³Ğ¾ Ğ¿Ñ€Ğ¾Ğ¼Ñ‚Ğ°.
    """
    if not products:
        return ""

    lines: List[str] = []
    for p in products:
        lines.append(f"Ğ˜ÑÑ‚Ğ¾Ñ‡Ğ½Ğ¸Ğº: {p.get('marketplace')}")
        name = p.get("name") or "Ğ±ĞµĞ· Ğ½Ğ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ñ"
        brand = p.get("brand")
        if brand:
            lines.append(f"Ğ¢Ğ¾Ğ²Ğ°Ñ€: {brand} â€” {name}")
        else:
            lines.append(f"Ğ¢Ğ¾Ğ²Ğ°Ñ€: {name}")

        price = p.get("price")
        if price:
            lines.append(f"ĞŸÑ€Ğ¸Ğ¼ĞµÑ€Ğ½Ğ°Ñ Ñ†ĞµĞ½Ğ°: Ğ¾ĞºĞ¾Ğ»Ğ¾ {int(price)} â‚½")

        rating = p.get("rating")
        feedbacks = p.get("feedbacks")
        if rating:
            if feedbacks:
                lines.append(f"Ğ ĞµĞ¹Ñ‚Ğ¸Ğ½Ğ³: {rating} Ğ¸Ğ· 5, Ğ¾Ñ‚Ğ·Ñ‹Ğ²Ğ¾Ğ²: {feedbacks}")
            else:
                lines.append(f"Ğ ĞµĞ¹Ñ‚Ğ¸Ğ½Ğ³: {rating} Ğ¸Ğ· 5")

        link = p.get("link")
        if link:
            lines.append(f"Ğ¡ÑÑ‹Ğ»ĞºĞ°: {link}")

        lines.append("---")

    return "\n".join(lines)


# ----------------- Ğ’Ñ‹Ğ·Ğ¾Ğ² Groq -----------------
async def call_groq(system_prompt: str, user_query: str) -> str:
    """
    Ğ’Ñ‹Ğ·Ğ¾Ğ² Groq. Ğ‘Ñ€Ğ¾ÑĞ°ĞµÑ‚ Ğ¸ÑĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ğµ, ĞµÑĞ»Ğ¸ Ñ‡Ñ‚Ğ¾-Ñ‚Ğ¾ Ğ¿Ğ¾ÑˆĞ»Ğ¾ Ğ½Ğµ Ñ‚Ğ°Ğº,
    Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ğ½Ğ°Ğ²ĞµÑ€Ñ…Ñƒ Ğ¼Ñ‹ Ğ¼Ğ¾Ğ³Ğ»Ğ¸ ÑƒĞ¹Ñ‚Ğ¸ Ğ² fallback.
    """
    if not client:
        raise RuntimeError("GROQ_API_KEY is not set or Groq client init failed")

    messages = [
        {"role": "system", "content": system_prompt},
        {"role": "user", "content": user_query.strip()},
    ]

    chat_completion = client.chat.completions.create(
        model=GROQ_MODEL,
        messages=messages,
        temperature=0.7,
        max_tokens=700,
        top_p=1,
    )

    content = chat_completion.choices[0].message.content or ""
    return content.strip()


async def generate_reply(system_prompt: str, query: str, scenario: str) -> Dict[str, str]:
    """
    ĞĞ±Ñ‰Ğ°Ñ Ğ»Ğ¾Ğ³Ğ¸ĞºĞ° Ğ³ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ğ¸ Ğ¾Ñ‚Ğ²ĞµÑ‚Ğ°: ÑĞ½Ğ°Ñ‡Ğ°Ğ»Ğ° Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ğ·Ğ°Ğ¿Ñ€Ğ¾Ñ, Ğ¿Ğ¾Ñ‚Ğ¾Ğ¼ Ğ¿Ñ€Ğ¾Ğ±ÑƒĞµĞ¼ Groq,
    Ğ¿Ñ€Ğ¸ Ğ¾ÑˆĞ¸Ğ±ĞºĞµ Ğ¿Ğ°Ğ´Ğ°ĞµĞ¼ Ğ² fallback.
    """
    safe_scenario = scenario or "product_pick"

    if not query or not query.strip():
        logger.info("ĞŸÑƒÑÑ‚Ğ¾Ğ¹ Ğ·Ğ°Ğ¿Ñ€Ğ¾Ñ â€” Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ÑĞµĞ¼ Ğ¿Ğ¾Ğ´ÑĞºĞ°Ğ·ĞºÑƒ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ")
        return {
            "reply_text": "ĞŸĞ¾ĞºĞ° Ñ Ğ½Ğµ Ğ²Ğ¸Ğ¶Ñƒ Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ°. ĞĞ°Ğ¿Ğ¸ÑˆĞ¸, Ñ‡Ñ‚Ğ¾ Ğ¸Ğ¼ĞµĞ½Ğ½Ğ¾ Ñ…Ğ¾Ñ‡ĞµÑˆÑŒ Ğ½Ğ°Ğ¹Ñ‚Ğ¸, Ğ±ÑĞ´Ğ¶ĞµÑ‚ Ğ¸ Ğ²Ğ°Ğ¶Ğ½Ñ‹Ğµ Ñ…Ğ°Ñ€Ğ°ĞºÑ‚ĞµÑ€Ğ¸ÑÑ‚Ğ¸ĞºĞ¸.",
            "scenario": safe_scenario,
        }

    try:
        if client is None:
            raise RuntimeError("Groq client is not available")

        answer = await call_groq(system_prompt, query)
        logger.info("Ğ£ÑĞ¿ĞµÑˆĞ½Ñ‹Ğ¹ Ğ¾Ñ‚Ğ²ĞµÑ‚ Ğ¾Ñ‚ Groq Ğ´Ğ»Ñ ÑÑ†ĞµĞ½Ğ°Ñ€Ğ¸Ñ %s", safe_scenario)
        return {
            "reply_text": answer,
            "scenario": safe_scenario,
        }

    except Exception as e:
        logger.exception("Groq API error: %s", e)
        return {
            "reply_text": FALLBACK_TEXT,
            "scenario": safe_scenario,
        }


# ----------------- FastAPI -----------------
app = FastAPI(
    title="MarketFox API (Groq, Railway)",
    description="Backend Ğ´Ğ»Ñ MarketFox Ğ¼Ğ°Ñ€ĞºĞµÑ‚Ğ¿Ğ»ĞµĞ¹Ñ-Ğ°ÑÑĞ¸ÑÑ‚ĞµĞ½Ñ‚Ğ° (Groq, Railway)",
    version="0.6.0",
)


@app.post("/marketfox")
async def marketfox_endpoint(payload: Dict[str, Any] = Body(...)) -> Dict[str, str]:
    """
    Ğ“Ğ»Ğ°Ğ²Ğ½Ğ°Ñ Ñ‚Ğ¾Ñ‡ĞºĞ°, ĞºÑƒĞ´Ğ° ÑˆĞ»Ñ‘Ñ‚ Ğ·Ğ°Ğ¿Ñ€Ğ¾Ñ BotHelp.
    ĞĞ¶Ğ¸Ğ´Ğ°ĞµĞ¼, Ñ‡Ñ‚Ğ¾ Ñ‚Ğ°Ğ¼ ĞµÑÑ‚ÑŒ Ğ¿Ğ¾Ğ»Ğµ 'Ğ—Ğ°Ğ¿Ñ€Ğ¾Ñ' Ğ¸ (Ğ¾Ğ¿Ñ†Ğ¸Ğ¾Ğ½Ğ°Ğ»ÑŒĞ½Ğ¾) 'scenario' Ğ¸Ğ»Ğ¸ 'Ğ¡Ñ†ĞµĞ½Ğ°Ñ€Ğ¸Ğ¹'.
    """
    logger.info("Incoming payload keys: %s", list(payload.keys()))

    # Ğ¢ĞµĞºÑÑ‚ Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ° Ğ¾Ñ‚ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ
    query = (
        payload.get("Ğ—Ğ°Ğ¿Ñ€Ğ¾Ñ")
        or payload.get("query")
        or payload.get("Query")
        or ""
    )

    # Ğ¡Ñ†ĞµĞ½Ğ°Ñ€Ğ¸Ğ¹: 'product_pick', 'gift', 'compare'
    scenario = (
        payload.get("scenario")
        or payload.get("Ğ¡Ñ†ĞµĞ½Ğ°Ñ€Ğ¸Ğ¹")
        or payload.get("ÑÑ†ĞµĞ½Ğ°Ñ€Ğ¸Ğ¹")
        or "product_pick"
    )

    logger.info("User scenario=%s query=%s", scenario, query)

    # ----- ĞĞ±Ğ¾Ğ³Ğ°Ñ‰ĞµĞ½Ğ¸Ğµ Ğ´Ğ»Ñ product_pick -----
    if scenario == "gift":
        system_prompt = PROMPT_GIFT

    elif scenario == "compare":
        system_prompt = PROMPT_COMPARE

    else:
        # Ğ¿Ğ¾ ÑƒĞ¼Ğ¾Ğ»Ñ‡Ğ°Ğ½Ğ¸Ñ â€” Ğ¿Ğ¾Ğ´Ğ±Ğ¾Ñ€ Ñ‚Ğ¾Ğ²Ğ°Ñ€Ğ°
        scenario = "product_pick"
        base_prompt = PROMPT_PRODUCT_PICK

        # Ğ˜Ñ‰ĞµĞ¼ Ñ‚Ğ¾Ğ²Ğ°Ñ€Ñ‹ Ğ½Ğ° Ğ¼Ğ°Ñ€ĞºĞµÑ‚Ğ¿Ğ»ĞµĞ¹ÑĞ°Ñ…
        search_query = clean_query_for_search(query)
        wb_products = await search_wildberries(search_query, limit=5)
        ozon_items = await search_ozon(search_query, limit=1)
        all_products = wb_products + ozon_items

        if all_products:
            marketplace_context = build_marketplace_context(all_products)
            system_prompt = (
                base_prompt
                + "\n\n"
                + "=== Ğ”ĞĞĞĞ«Ğ• Ğ¡ ĞœĞĞ ĞšĞ•Ğ¢ĞŸĞ›Ğ•Ğ™Ğ¡ĞĞ’ ===\n"
                + marketplace_context
                + "\n\n"
                + "Ğ•ÑĞ»Ğ¸ Ğ² ÑÑ‚Ğ¾Ğ¼ Ğ±Ğ»Ğ¾ĞºĞµ ĞµÑÑ‚ÑŒ ĞºĞ¾Ğ½ĞºÑ€ĞµÑ‚Ğ½Ñ‹Ğµ Ñ‚Ğ¾Ğ²Ğ°Ñ€Ñ‹ Ñ Wildberries/Ozon:\n"
                  "- ĞĞ‘Ğ¯Ğ—ĞĞ¢Ğ•Ğ›Ğ¬ĞĞ ÑƒĞ¿Ğ¾Ğ¼Ğ¸Ğ½Ğ°Ğ¹ Ğ¼Ğ¸Ğ½Ğ¸Ğ¼ÑƒĞ¼ 2â€“3 Ğ¸Ğ· Ğ½Ğ¸Ñ… Ğ² Ğ¾Ñ‚Ğ²ĞµÑ‚Ğµ;\n"
                  "- Ğ¿Ğ¾ ĞºĞ°Ğ¶Ğ´Ğ¾Ğ¼Ñƒ Ğ½Ğ°Ğ¿Ğ¸ÑˆĞ¸, ĞºĞ¾Ğ¼Ñƒ Ğ¾Ğ½ Ğ¿Ğ¾Ğ´Ğ¾Ğ¹Ğ´Ñ‘Ñ‚ Ğ¸ Ğ² Ñ‡Ñ‘Ğ¼ Ğ¿Ğ»ÑÑÑ‹;\n"
                  "- ÑÑÑ‹Ğ»ĞºÑƒ Ğ¿Ğ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°Ğ¹ Ğ¾Ñ‚Ğ´ĞµĞ»ÑŒĞ½Ğ¾Ğ¹ ÑÑ‚Ñ€Ğ¾ĞºĞ¾Ğ¹, Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ ĞµÑ‘ Ğ¼Ğ¾Ğ¶Ğ½Ğ¾ Ğ±Ñ‹Ğ»Ğ¾ Ğ½Ğ°Ğ¶Ğ°Ñ‚ÑŒ.\n"
                  "Ğ•ÑĞ»Ğ¸ Ñ‚Ğ¾Ğ²Ğ°Ñ€Ğ¾Ğ² Ğ½ĞµÑ‚, Ğ´Ğ°Ğ²Ğ°Ğ¹ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ Ğ¾Ğ±Ñ‰Ğ¸Ğµ Ñ€ĞµĞºĞ¾Ğ¼ĞµĞ½Ğ´Ğ°Ñ†Ğ¸Ğ¸ Ğ±ĞµĞ· ÑÑÑ‹Ğ»Ğ¾Ğº."
            )
        else:
            system_prompt = base_prompt

    result = await generate_reply(system_prompt, query, scenario)
    return result


@app.get("/")
async def root() -> Dict[str, str]:
    return {"status": "ok", "message": "MarketFox backend is running"}
