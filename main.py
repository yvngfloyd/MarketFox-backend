import os
import logging
from datetime import datetime
from pathlib import Path
from typing import Any, Dict, Optional

from fastapi import FastAPI, Body
from fastapi.staticfiles import StaticFiles
from groq import Groq
from reportlab.pdfgen import canvas

# ----------------- –õ–æ–≥–≥–µ—Ä -----------------
logger = logging.getLogger("legalfox")
logger.setLevel(logging.INFO)
handler = logging.StreamHandler()
handler.setFormatter(logging.Formatter("[%(asctime)s] %(levelname)s: %(message)s"))
logger.addHandler(handler)

# ----------------- –ö–æ–Ω—Ñ–∏–≥ -----------------
GROQ_API_KEY = os.getenv("GROQ_API_KEY")
GROQ_MODEL = "llama-3.1-8b-instant"

# –ë–∞–∑–æ–≤—ã–π URL —Ç–≤–æ–µ–≥–æ –±—ç–∫–µ–Ω–¥–∞ (–¥–ª—è —Å—Å—ã–ª–æ–∫ –Ω–∞ —Ñ–∞–π–ª—ã)
BASE_URL = os.getenv("BASE_URL", "https://legalfox.up.railway.app")

# –ü–∞–ø–∫–∞ –¥–ª—è PDF-—Ñ–∞–π–ª–æ–≤
BASE_DIR = Path(__file__).parent
FILES_DIR = BASE_DIR / "files"
FILES_DIR.mkdir(parents=True, exist_ok=True)

# ----------------- Fallback-—Ç–µ–∫—Å—Ç -----------------
FALLBACK_TEXT = (
    "–°–µ–π—á–∞—Å —è –Ω–µ –º–æ–≥—É –æ–±—Ä–∞—Ç–∏—Ç—å—Å—è –∫ –Ω–µ–π—Ä–æ—Å–µ—Ç–∏. "
    "–ü–æ–ø—Ä–æ–±—É–π –ø–µ—Ä–µ—Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∞—Ç—å –∑–∞–ø—Ä–æ—Å –∏–ª–∏ –ø–æ–≤—Ç–æ—Ä–∏—Ç—å —á—É—Ç—å –ø–æ–∑–∂–µ."
)

# ----------------- –ü–†–û–ú–ü–¢–´ -----------------

PROMPT_CONTRACT = """
–¢—ã ‚Äî LegalFox, –ò–ò-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç, –ø–æ–º–æ–≥–∞—é—â–∏–π —é—Ä–∏—Å—Ç–∞–º –∏ –ø—Ä–µ–¥–ø—Ä–∏–Ω–∏–º–∞—Ç–µ–ª—è–º —Å–æ—Å—Ç–∞–≤–ª—è—Ç—å —á–µ—Ä–Ω–æ–≤–∏–∫–∏ –≥—Ä–∞–∂–¥–∞–Ω—Å–∫–æ-–ø—Ä–∞–≤–æ–≤—ã—Ö –¥–æ–≥–æ–≤–æ—Ä–æ–≤ –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ.

–¢–í–û–Ø –ó–ê–î–ê–ß–ê –í –≠–¢–û–ú –°–¶–ï–ù–ê–†–ò–ò:
‚Äî –ù–∞ –æ—Å–Ω–æ–≤–µ –∫—Ä–∞—Ç–∫–æ–≥–æ –æ–ø—Ä–æ—Å–Ω–∏–∫–∞ (—Ç–∏–ø –¥–æ–≥–æ–≤–æ—Ä–∞, —Å—Ç–æ—Ä–æ–Ω—ã, –ø—Ä–µ–¥–º–µ—Ç, —Å—Ä–æ–∫–∏/–æ–ø–ª–∞—Ç–∞, –æ—Å–æ–±—ã–µ —É—Å–ª–æ–≤–∏—è) —Å–æ–±—Ä–∞—Ç—å –∞–∫–∫—É—Ä–∞—Ç–Ω—ã–π –ß–ï–†–ù–û–í–ò–ö –¥–æ–≥–æ–≤–æ—Ä–∞.
‚Äî –≠—Ç–æ –Ω–µ –≥–æ—Ç–æ–≤—ã–π –∫ –ø–æ–¥–ø–∏—Å–∞–Ω–∏—é –¥–æ–∫—É–º–µ–Ω—Ç, –∞ —É–¥–æ–±–Ω–∞—è –∑–∞–≥–æ—Ç–æ–≤–∫–∞, –∫–æ—Ç–æ—Ä—É—é —é—Ä–∏—Å—Ç –ø–æ—Ç–æ–º –ø–æ–ø—Ä–∞–≤–∏—Ç –ø–æ–¥ –¥–µ–ª–æ.

–û–ë–©–ò–ï –¢–†–ï–ë–û–í–ê–ù–ò–Ø –ö –û–¢–í–ï–¢–£:
‚Äî –ü–∏—à–∏ –ø–æ-—Ä—É—Å—Å–∫–∏, –Ω–æ—Ä–º–∞–ª—å–Ω—ã–º —é—Ä–∏–¥–∏—á–µ—Å–∫–∏–º —è–∑—ã–∫–æ–º –±–µ–∑ –ª–∏—à–Ω–µ–π –≤–æ–¥—ã.
‚Äî –°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä—É–π —Ç–µ–∫—Å—Ç –±–ª–æ–∫–∞–º–∏: –ø—Ä–µ–∞–º–±—É–ª–∞, –ø—Ä–µ–¥–º–µ—Ç, –ø—Ä–∞–≤–∞ –∏ –æ–±—è–∑–∞–Ω–Ω–æ—Å—Ç–∏, —Ü–µ–Ω–∞/–ø–æ—Ä—è–¥–æ–∫ —Ä–∞—Å—á—ë—Ç–æ–≤ (–µ—Å–ª–∏ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ), –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å, –ø–æ—Ä—è–¥–æ–∫ —Ä–∞—Å—Ç–æ—Ä–∂–µ–Ω–∏—è, –ø—Ä–æ—á–∏–µ —É—Å–ª–æ–≤–∏—è, —Ä–µ–∫–≤–∏–∑–∏—Ç—ã.
‚Äî –ù–ï –ø—Ä–∏–¥—É–º—ã–≤–∞–π –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —Ä–µ–∫–≤–∏–∑–∏—Ç—ã (–ò–ù–ù, –û–ì–†–ù, –∞–¥—Ä–µ—Å–∞), –æ—Å—Ç–∞–≤–ª—è–π —à–∞–±–ª–æ–Ω–Ω—ã–µ –∑–∞–≥–ª—É—à–∫–∏ –≤–∏–¥–∞: ¬´___¬ª.
‚Äî –ï—Å–ª–∏ –¥–∞–Ω–Ω—ã—Ö –º–∞–ª–æ, –∞–∫–∫—É—Ä–∞—Ç–Ω–æ ¬´–¥–æ–¥—É–º—ã–≤–∞–π¬ª —Ç–æ–ª—å–∫–æ –Ω–µ–π—Ç—Ä–∞–ª—å–Ω—ã–µ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∫–∏ (—Ç–∏–ø–æ–≤—ã–µ –ø—Ä–∞–≤–∞/–æ–±—è–∑–∞–Ω–Ω–æ—Å—Ç–∏, –æ–±—â–∏–µ —Ñ—Ä–∞–∑—ã –ø—Ä–æ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å).

–û–ß–ï–ù–¨ –í–ê–ñ–ù–û:
‚Äî –ù–µ –≤—ã–¥–∞–≤–∞–π —Å–æ–≤–µ—Ç–æ–≤ –≤ –¥—É—Ö–µ ¬´–ø–æ–¥–ø–∏—Å—ã–≤–∞—Ç—å/–Ω–µ –ø–æ–¥–ø–∏—Å—ã–≤–∞—Ç—å¬ª.
‚Äî –ù–µ –∏–∑–æ–±—Ä–∞–∂–∞–π –∏–∑ —Å–µ–±—è –∞–¥–≤–æ–∫–∞—Ç–∞, –ø—Ä–æ—Å—Ç–æ —Ñ–æ—Ä–º–∏—Ä—É–π —É–¥–æ–±–Ω—ã–π —Ç–µ–∫—Å—Ç–æ–≤—ã–π —á–µ—Ä–Ω–æ–≤–∏–∫.
"""

PROMPT_CLAIM = """
–¢—ã ‚Äî LegalFox, –ò–ò-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –¥–ª—è —é—Ä–∏—Å—Ç–æ–≤.

–°–¶–ï–ù–ê–†–ò–ô: –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –ß–ï–†–ù–û–í–ò–ö–ê –ü–†–ï–¢–ï–ù–ó–ò–ò (–¥–æ—Å—É–¥–µ–±–Ω–æ–π, –ø–æ –≥—Ä–∞–∂–¥–∞–Ω—Å–∫–∏–º/—Ö–æ–∑—è–π—Å—Ç–≤–µ–Ω–Ω—ã–º —Å–ø–æ—Ä–∞–º).
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–∞—ë—Ç:
‚Äî –∞–¥—Ä–µ—Å–∞—Ç–∞ –ø—Ä–µ—Ç–µ–Ω–∑–∏–∏,
‚Äî –∫—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –æ—Å–Ω–æ–≤–∞–Ω–∏—è,
‚Äî —Ñ–∞–∫—Ç—ã –Ω–∞—Ä—É—à–µ–Ω–∏—è –∏ –æ–±—Å—Ç–æ—è—Ç–µ–ª—å—Å—Ç–≤–∞,
‚Äî —Å–≤–æ–∏ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è,
‚Äî –∂–µ–ª–∞–µ–º—ã–π —Å—Ä–æ–∫ –∏—Å–ø–æ–ª–Ω–µ–Ω–∏—è –∏ –∫–æ–Ω—Ç–∞–∫—Ç—ã.

–°–§–û–†–ú–ò–†–£–ô —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—É—é –ø—Ä–µ—Ç–µ–Ω–∑–∏—é —Å–æ —Å–ª–µ–¥—É—é—â–∏–º–∏ –±–ª–æ–∫–∞–º–∏:
1) ¬´–®–∞–ø–∫–∞¬ª (–ö–æ–º—É, –û—Ç –∫–æ–≥–æ, –∫–æ–Ω—Ç–∞–∫—Ç—ã ‚Äî –µ—Å–ª–∏ —á–µ–≥–æ-—Ç–æ —è–≤–Ω–æ –Ω–µ—Ç, –æ—Å—Ç–∞–≤—å ¬´___¬ª).
2) –í—Å—Ç—É–ø–ª–µ–Ω–∏–µ: —Å—Å—ã–ª–∫–∞ –Ω–∞ –¥–æ–≥–æ–≤–æ—Ä/–æ—Å–Ω–æ–≤–∞–Ω–∏–µ (–µ—Å–ª–∏ —É–∫–∞–∑–∞–Ω–æ).
3) –û–ø–∏—Å–∞–Ω–∏–µ –Ω–∞—Ä—É—à–µ–Ω–∏—è –∏ —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏—Ö –æ–±—Å—Ç–æ—è—Ç–µ–ª—å—Å—Ç–≤.
4) –£–∫–∞–∑–∞–Ω–∏–µ –Ω–∞ –Ω–∞—Ä—É—à–µ–Ω–Ω—ã–µ –æ–±—è–∑–∞—Ç–µ–ª—å—Å—Ç–≤–∞/–Ω–æ—Ä–º—ã –ø—Ä–∞–≤–∞ (–æ–±—â–æ, –±–µ–∑ —Ñ–∞–Ω–∞—Ç–∏–∑–º–∞).
5) –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –∑–∞—è–≤–∏—Ç–µ–ª—è.
6) –°—Ä–æ–∫ –¥–ª—è –¥–æ–±—Ä–æ–≤–æ–ª—å–Ω–æ–≥–æ –∏—Å–ø–æ–ª–Ω–µ–Ω–∏—è.
7) –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –æ –≤–æ–∑–º–æ–∂–Ω—ã—Ö –¥–∞–ª—å–Ω–µ–π—à–∏—Ö –¥–µ–π—Å—Ç–≤–∏—è—Ö (—Å—É–¥, –≤–∑—ã—Å–∫–∞–Ω–∏–µ —Ä–∞—Å—Ö–æ–¥–æ–≤ –∏ —Ç.–ø.).
8) –ó–∞–∫–ª—é—á–∏—Ç–µ–ª—å–Ω–∞—è —á–∞—Å—Ç—å (–ø–æ–¥–ø–∏—Å—å, –¥–∞—Ç–∞ ‚Äî –æ—Å—Ç–∞–≤–∏—Ç—å –∫–∞–∫ ¬´___¬ª).

–ü–ò–®–ò:
‚Äî –ø–æ-–¥–µ–ª–æ–≤–æ–º—É, –Ω–æ –±–µ–∑ –ª–∏—à–Ω–µ–π –∫–∞–Ω—Ü–µ–ª—è—Ä—â–∏–Ω—ã;
‚Äî –∫–æ–º–ø–∞–∫—Ç–Ω–æ, 1‚Äì2 –∞–±–∑–∞—Ü–∞ –Ω–∞ –±–ª–æ–∫;
‚Äî –±–µ–∑ —É–∫–∞–∑–∞–Ω–∏—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö —Å—Ç–∞—Ç–µ–π, –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∏—Ö —Å–∞–º –Ω–µ –Ω–∞–∑–≤–∞–ª (–º–æ–∂–Ω–æ –ø–∏—Å–∞—Ç—å –æ–±—â–∏–µ —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∫–∏ —Ç–∏–ø–∞ ¬´–≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–∏ —Å –¥–µ–π—Å—Ç–≤—É—é—â–∏–º –∑–∞–∫–æ–Ω–æ–¥–∞—Ç–µ–ª—å—Å—Ç–≤–æ–º –†–§¬ª).

–≠—Ç–æ –∏–º–µ–Ω–Ω–æ —á–µ—Ä–Ω–æ–≤–∏–∫. –¢—ã –Ω–µ –Ω–µ—Å—ë—à—å –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å –∑–∞ –µ–≥–æ —é—Ä–∏–¥–∏—á–µ—Å–∫—É—é —Å–∏–ª—É ‚Äî —ç—Ç–æ —Ç–µ–∫—Å—Ç –¥–ª—è –ø–æ—Å–ª–µ–¥—É—é—â–µ–π –¥–æ—Ä–∞–±–æ—Ç–∫–∏ —é—Ä–∏—Å—Ç–æ–º.
"""

PROMPT_CLAUSE = """
–¢—ã ‚Äî LegalFox, –ò–ò-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç, –∫–æ—Ç–æ—Ä—ã–π –ø–æ–º–æ–≥–∞–µ—Ç —é—Ä–∏—Å—Ç—É –±—ã—Å—Ç—Ä–æ –∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∏ —É–ª—É—á—à–∞—Ç—å –æ—Ç–¥–µ–ª—å–Ω—ã–µ —É—Å–ª–æ–≤–∏—è –¥–æ–≥–æ–≤–æ—Ä–∞.

–ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–¨ –ø—Ä–∏—Å—ã–ª–∞–µ—Ç:
‚Äî –æ–¥–∏–Ω –ø—É–Ω–∫—Ç –¥–æ–≥–æ–≤–æ—Ä–∞
–ò–õ–ò
‚Äî –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å–≤—è–∑–∞–Ω–Ω—ã—Ö —É—Å–ª–æ–≤–∏–π/–∞–±–∑–∞—Ü–µ–≤.

–¢–í–û–Ø –ó–ê–î–ê–ß–ê:
1) –ö—Ä–∞—Ç–∫–æ (1‚Äì3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è) –ø–æ—è—Å–Ω–∏—Ç—å, —á—Ç–æ –ø–æ —Å—É—Ç–∏ –¥–µ–ª–∞–µ—Ç —ç—Ç–æ—Ç –ø—É–Ω–∫—Ç/–Ω–∞–±–æ—Ä –ø—É–Ω–∫—Ç–æ–≤.
2) –£–∫–∞–∑–∞—Ç—å –≤–æ–∑–º–æ–∂–Ω—ã–µ —Ä–∏—Å–∫–∏/—Å–ª–∞–±—ã–µ –º–µ—Å—Ç–∞ –¥–ª—è —Å—Ç–æ—Ä–æ–Ω—ã –∫–ª–∏–µ–Ω—Ç–∞ (–µ—Å–ª–∏ —ç—Ç–æ –º–æ–∂–Ω–æ —Å–∫–∞–∑–∞—Ç—å –±–µ–∑ –≥–ª—É–±–æ–∫–æ–≥–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞).
3) –ü—Ä–µ–¥–ª–æ–∂–∏—Ç—å 1‚Äì2 –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∫–∏: –±–æ–ª–µ–µ –±–µ–∑–æ–ø–∞—Å–Ω—É—é/–≤—ã–≥–æ–¥–Ω—É—é –¥–ª—è –∫–ª–∏–µ–Ω—Ç–∞ –ò–õ–ò –±–æ–ª–µ–µ —Å–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–Ω—É—é.

–§–û–†–ú–ê–¢ –û–¢–í–ï–¢–ê:
‚Äî –°–Ω–∞—á–∞–ª–∞ ¬´–ö—Ä–∞—Ç–∫–∏–π —Å–º—ã—Å–ª: ‚Ä¶¬ª
‚Äî –ó–∞—Ç–µ–º ¬´–†–∏—Å–∫–∏: ‚Ä¶¬ª (–µ—Å–ª–∏ –≤–∏–¥–∏—à—å –æ—á–µ–≤–∏–¥–Ω—ã–µ).
‚Äî –ó–∞—Ç–µ–º ¬´–í–∞—Ä–∏–∞–Ω—Ç —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∫–∏ 1: ‚Ä¶¬ª
‚Äî –ü–æ –∂–µ–ª–∞–Ω–∏—é ¬´–í–∞—Ä–∏–∞–Ω—Ç —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∫–∏ 2: ‚Ä¶¬ª

–ù–ï –î–ï–õ–ê–ô:
‚Äî –≤—ã–≤–æ–¥–æ–≤ —É—Ä–æ–≤–Ω—è ¬´–¥–æ–≥–æ–≤–æ—Ä —Ç–æ—á–Ω–æ –Ω–µ–¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω¬ª;
‚Äî –∫–∞—Ç–µ–≥–æ—Ä–∏—á–Ω—ã—Ö —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π –±–µ–∑ –æ–≥–æ–≤–æ—Ä–æ–∫.
–ì–æ–≤–æ—Ä–∏ –∫–∞–∫ ¬´—á–µ—Ä–Ω–æ–≤–æ–π –ø–æ–º–æ—â–Ω–∏–∫ —é—Ä–∏—Å—Ç–∞¬ª, –∞ –Ω–µ –∫–∞–∫ –æ–∫–æ–Ω—á–∞—Ç–µ–ª—å–Ω—ã–π —ç–∫—Å–ø–µ—Ä—Ç.
"""

# ----------------- Groq-–∫–ª–∏–µ–Ω—Ç -----------------

client: Optional[Groq] = None
if GROQ_API_KEY:
    try:
        client = Groq(api_key=GROQ_API_KEY)
        logger.info("Groq client –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω")
    except Exception:
        logger.exception("–ù–µ —É–¥–∞–ª–æ—Å—å –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å Groq client")
else:
    logger.warning("GROQ_API_KEY –Ω–µ –∑–∞–¥–∞–Ω ‚Äî –±—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è fallback –±–µ–∑ –ò–ò")


async def call_groq(system_prompt: str, user_query: str) -> str:
    if not client:
        raise RuntimeError("Groq client is not available")

    messages = [
        {"role": "system", "content": system_prompt},
        {"role": "user", "content": user_query.strip()},
    ]

    chat_completion = client.chat.completions.create(
        model=GROQ_MODEL,
        messages=messages,
        temperature=0.7,
        max_tokens=1300,
        top_p=1,
    )

    content = chat_completion.choices[0].message.content or ""
    return content.strip()


# ----------------- –ì–µ–Ω–µ—Ä–∞—Ü–∏—è PDF -----------------


def create_contract_pdf(text: str) -> str:
    """
    –°–æ–∑–¥–∞—ë—Ç PDF —Å —Ç–µ–∫—Å—Ç–æ–º —á–µ—Ä–Ω–æ–≤–∏–∫–∞ –¥–æ–≥–æ–≤–æ—Ä–∞ –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ò–ú–Ø —Ñ–∞–π–ª–∞.
    –§–∞–π–ª –∫–ª–∞–¥—ë–º –≤ –ø–∞–ø–∫—É FILES_DIR, –æ—Ç–¥–∞—ë–º –ø–æ /files/{filename}.
    """
    ts = datetime.utcnow().strftime("%Y%m%d_%H%M%S")
    filename = f"contract_{ts}.pdf"
    pdf_path = FILES_DIR / filename

    # –ü—Ä–æ—Å—Ç–µ–π—à–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è: —Ç–µ–∫—Å—Ç –±–ª–æ—á–Ω—ã–º –≤—ã–≤–æ–¥–æ–º
    c = canvas.Canvas(str(pdf_path))

    # –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π —à—Ä–∏—Ñ—Ç PDF (—á—Ç–æ–± —Ç–æ—á–Ω–æ –Ω–µ —É–ø–∞—Å—Ç—å). –° –∫–∏—Ä–∏–ª–ª–∏—Ü–µ–π –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ–∏–¥–µ–∞–ª—å–Ω–æ,
    # –Ω–æ –¥–ª—è —Ç–µ—Å—Ç–∞ —ç—Ç–æ –æ–∫. –ü–æ–∑–∂–µ –º–æ–∂–Ω–æ –ø—Ä–∏–∫—Ä—É—Ç–∏—Ç—å TTF-—à—Ä–∏—Ñ—Ç.
    c.setFont("Helvetica", 11)

    width, height = c._pagesize
    x = 40
    y = height - 40
    max_width = width - 80
    line_height = 14

    # –ü—Ä–æ—Å—Ç–∞—è —Ä–∞–∑–±–∏–≤–∫–∞ –Ω–∞ —Å—Ç—Ä–æ–∫–∏ –ø–æ \n, –±–µ–∑ —É–º–Ω–æ–≥–æ –ø–µ—Ä–µ–Ω–æ—Å–æ–≤
    for paragraph in text.split("\n"):
        paragraph = paragraph.rstrip()
        if not paragraph:
            y -= line_height  # –ø—É—Å—Ç–∞—è —Å—Ç—Ä–æ–∫–∞
            continue

        # –ï—Å–ª–∏ —Å—Ç—Ä–æ–∫–∞ –æ—á–µ–Ω—å –¥–ª–∏–Ω–Ω–∞—è ‚Äî —Ç—É–ø–æ —Ä—É–±–∏–º –ø–æ –¥–ª–∏–Ω–µ, —á—Ç–æ–±—ã –Ω–µ –≤—ã–ª–µ–∑–∞–ª–æ –∑–∞ –∫—Ä–∞–π
        while paragraph:
            # –≥—Ä—É–±—ã–π –ª–∏–º–∏—Ç –ø–æ —Å–∏–º–≤–æ–ª–∞–º
            chunk = paragraph[:120]
            paragraph = paragraph[120:]
            c.drawString(x, y, chunk)
            y -= line_height
            if y < 60:  # –Ω–æ–≤–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞
                c.showPage()
                c.setFont("Helvetica", 11)
                y = height - 40

    c.save()
    logger.info("PDF —Å–æ–∑–¥–∞–Ω: %s", pdf_path)
    return filename


# ----------------- –û–±—â–∞—è –ª–æ–≥–∏–∫–∞ –æ—Ç–≤–µ—Ç–∞ -----------------


async def generate_reply(payload: Dict[str, Any]) -> Dict[str, Any]:
    scenario = (
        payload.get("scenario")
        or payload.get("–°—Ü–µ–Ω–∞—Ä–∏–π")
        or payload.get("—Å—Ü–µ–Ω–∞—Ä–∏–π")
        or "contract"
    )

    # CONTRACT
    if scenario == "contract":
        # –°—á–∏—Ç—ã–≤–∞–µ–º –ø–æ–ª—è (—Å —É—á—ë—Ç–æ–º —Ç–≤–æ–∏—Ö –Ω–∞–∑–≤–∞–Ω–∏–π —Å –ø—Ä–æ–±–µ–ª–∞–º–∏)
        type_field = payload.get("–¢–∏–ø_–¥–æ–≥–æ–≤–æ—Ä–∞") or payload.get("–¢–∏–ø –¥–æ–≥–æ–≤–æ—Ä–∞") or ""
        parties = payload.get("–°—Ç–æ—Ä–æ–Ω—ã") or ""
        subject = payload.get("–ü—Ä–µ–¥–º–µ—Ç") or ""
        terms = payload.get("–°—Ä–æ–∫–∏_–∏_–æ–ø–ª–∞—Ç–∞") or payload.get("–°—Ä–æ–∫–∏ –∏ –æ–ø–ª–∞—Ç–∞") or ""
        special = payload.get("–û—Å–æ–±—ã–µ_—É—Å–ª–æ–≤–∏—è") or payload.get("–û—Å–æ–±—ã–µ —É—Å–ª–æ–≤–∏—è") or ""

        # –ï—Å–ª–∏ –ø–æ—á—Ç–∏ –Ω–∏—á–µ–≥–æ –Ω–µ—Ç ‚Äî —Å—Ä–∞–∑—É –ø—Ä–æ—Å–∏–º —É—Ç–æ—á–Ω–∏—Ç—å
        if not any([type_field, parties, subject]):
            return {
                "reply_text": "–ü–æ–∫–∞ –º–∞–ª–æ –¥–∞–Ω–Ω—ã—Ö. –ù–∞–ø–∏—à–∏ —Ö–æ—Ç—è –±—ã —Ç–∏–ø –¥–æ–≥–æ–≤–æ—Ä–∞, —Å—Ç–æ—Ä–æ–Ω—ã –∏ –ø—Ä–µ–¥–º–µ—Ç.",
                "scenario": "contract",
            }

        user_query = (
            f"–¢–∏–ø –¥–æ–≥–æ–≤–æ—Ä–∞: {type_field}\n"
            f"–°—Ç–æ—Ä–æ–Ω—ã: {parties}\n"
            f"–ü—Ä–µ–¥–º–µ—Ç: {subject}\n"
            f"–°—Ä–æ–∫–∏ –∏ –æ–ø–ª–∞—Ç–∞: {terms}\n"
            f"–û—Å–æ–±—ã–µ —É—Å–ª–æ–≤–∏—è: {special}"
        )

        try:
            if not client:
                raise RuntimeError("Groq client is not available")

            contract_text = await call_groq(PROMPT_CONTRACT, user_query)

            # –ü—ã—Ç–∞–µ–º—Å—è —Å–æ–∑–¥–∞—Ç—å PDF. –ï—Å–ª–∏ –≤–¥—Ä—É–≥ —á—Ç–æ-—Ç–æ –ø–æ–π–¥—ë—Ç –Ω–µ —Ç–∞–∫ ‚Äî –ª–æ–≥–∏—Ä—É–µ–º –∏ –ø—Ä–æ—Å—Ç–æ –æ—Ç–¥–∞—ë–º —Ç–µ–∫—Å—Ç.
            try:
                filename = create_contract_pdf(contract_text)
                file_url = f"{BASE_URL}/files/{filename}"
                reply_text = f"–ì–æ—Ç–æ–≤–æ! –Ø —Å–æ–±—Ä–∞–ª —á–µ—Ä–Ω–æ–≤–∏–∫, –ª–æ–≤–∏ üìÑ\n{file_url}"
                return {
                    "reply_text": reply_text,
                    "file_url": file_url,
                    "scenario": "contract",
                }
            except Exception:
                logger.exception("–û—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ PDF, –æ—Ç–¥–∞—é —Ç–æ–ª—å–∫–æ —Ç–µ–∫—Å—Ç")
                return {
                    "reply_text": contract_text,
                    "scenario": "contract",
                }

        except Exception as e:
            logger.exception("Groq/contract error: %s", e)
            return {"reply_text": FALLBACK_TEXT, "scenario": "contract"}

    # CLAIM (–ø—Ä–µ—Ç–µ–Ω–∑–∏—è)
    if scenario == "claim":
        adresat = payload.get("–ê–¥—Ä–µ—Å–∞—Ç") or ""
        basis = payload.get("–û—Å–Ω–æ–≤–∞–Ω–∏–µ") or ""
        facts = (
            payload.get("–ù–∞—Ä—É—à–µ–Ω–∏–µ_–∏_–æ–±—Å—Ç–æ—è—Ç–µ–ª—å—Å—Ç–≤–∞")
            or payload.get("–ù–∞—Ä—É—à–µ–Ω–∏–µ –∏ –æ–±—Å—Ç–æ—è—Ç–µ–ª—å—Å—Ç–≤–∞")
            or ""
        )
        demands = payload.get("–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è") or ""
        deadline = payload.get("–°—Ä–æ–∫_–∏—Å–ø–æ–ª–Ω–µ–Ω–∏—è") or payload.get("–°—Ä–æ–∫–∏ –∏—Å–ø–æ–ª–Ω–µ–Ω–∏—è") or ""
        contacts = payload.get("–ö–æ–Ω—Ç–∞–∫—Ç—ã") or ""

        if not (adresat or facts or demands):
            return {
                "reply_text": "–ü–æ–∫–∞ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö. –ù–∞–ø–∏—à–∏, –∫–æ–º—É –∏ –ø–æ –∫–∞–∫–æ–º—É –ø–æ–≤–æ–¥—É –Ω—É–∂–Ω–æ —Å–æ—Å—Ç–∞–≤–∏—Ç—å –ø—Ä–µ—Ç–µ–Ω–∑–∏—é.",
                "scenario": "claim",
            }

        user_query = (
            f"–ê–¥—Ä–µ—Å–∞—Ç: {adresat}\n"
            f"–û—Å–Ω–æ–≤–∞–Ω–∏–µ: {basis}\n"
            f"–ù–∞—Ä—É—à–µ–Ω–∏–µ –∏ –æ–±—Å—Ç–æ—è—Ç–µ–ª—å—Å—Ç–≤–∞: {facts}\n"
            f"–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è: {demands}\n"
            f"–°—Ä–æ–∫ –∏—Å–ø–æ–ª–Ω–µ–Ω–∏—è: {deadline}\n"
            f"–ö–æ–Ω—Ç–∞–∫—Ç—ã: {contacts}"
        )

        try:
            text = await call_groq(PROMPT_CLAIM, user_query)
            return {"reply_text": text, "scenario": "claim"}
        except Exception as e:
            logger.exception("Groq/claim error: %s", e)
            return {"reply_text": FALLBACK_TEXT, "scenario": "claim"}

    # CLAUSE (–ø—Ä–æ–≤–µ—Ä–∫–∞ –ø—É–Ω–∫—Ç–∞)
    if scenario == "clause":
        clause_text = (
            payload.get("–§—Ä–∞–≥–º–µ–Ω—Ç") or payload.get("–¢–µ–∫—Å—Ç") or payload.get("–ó–∞–ø—Ä–æ—Å") or ""
        )

        if not clause_text.strip():
            return {
                "reply_text": "–ü–æ–∫–∞ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö. –ù–∞–ø–∏—à–∏ —Ç–µ–∫—Å—Ç/–æ–ø–∏—Å–∞–Ω–∏–µ, —Å –∫–æ—Ç–æ—Ä—ã–º –Ω—É–∂–Ω–æ –ø–æ–º–æ—á—å.",
                "scenario": "clause",
            }

        try:
            text = await call_groq(PROMPT_CLAUSE, clause_text)
            return {"reply_text": text, "scenario": "clause"}
        except Exception as e:
            logger.exception("Groq/clause error: %s", e)
            return {"reply_text": FALLBACK_TEXT, "scenario": "clause"}

    # –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é ‚Äî –ø—Ä–æ—Å—Ç–æ echo —Å fallback
    logger.info("–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Å—Ü–µ–Ω–∞—Ä–∏–π: %s", scenario)
    return {"reply_text": FALLBACK_TEXT, "scenario": scenario}


# ----------------- FastAPI -----------------

app = FastAPI(
    title="LegalFox API (Groq, Railway)",
    description="Backend –¥–ª—è LegalFox ‚Äî –ò–ò-–ø–æ–º–æ—â–Ω–∏–∫–∞ —é—Ä–∏—Å—Ç–∞–º",
    version="0.4.0",
)

# –†–∞–∑–¥–∞—ë–º —Ñ–∞–π–ª—ã –∏–∑ –ø–∞–ø–∫–∏ files –ø–æ /files/*
app.mount("/files", StaticFiles(directory=str(FILES_DIR)), name="files")


@app.post("/legalfox")
async def legalfox_endpoint(payload: Dict[str, Any] = Body(...)) -> Dict[str, Any]:
    logger.info("Incoming payload keys: %s", list(payload.keys()))
    result = await generate_reply(payload)
    logger.info("Scenario=%s –æ—Ç–≤–µ—Ç –≥–æ—Ç–æ–≤", result.get("scenario"))
    return result


@app.get("/")
async def root() -> Dict[str, str]:
    return {"status": "ok", "message": "LegalFox backend is running"}
