import os
import logging
from typing import Any, Dict

from fastapi import FastAPI, Body
from groq import Groq

# -------------------------------------------------
# Ğ›Ğ¾Ğ³Ğ³ĞµÑ€
# -------------------------------------------------
logger = logging.getLogger("legalfox")
logger.setLevel(logging.INFO)
handler = logging.StreamHandler()
handler.setFormatter(logging.Formatter("[%(asctime)s] %(levelname)s: %(message)s"))
logger.addHandler(handler)

# -------------------------------------------------
# ĞšĞ¾Ğ½Ñ„Ğ¸Ğ³
# -------------------------------------------------
GROQ_API_KEY = os.getenv("GROQ_API_KEY")
GROQ_MODEL = "llama-3.1-8b-instant"

# Ğ•ÑĞ»Ğ¸ Groq ÑƒĞ¿Ğ°Ğ» / Ğ½Ğµ Ğ½Ğ°ÑÑ‚Ñ€Ğ¾ĞµĞ½
FALLBACK_TEXT = (
    "Ğ¡ĞµĞ¹Ñ‡Ğ°Ñ Ğ½Ğµ Ğ¼Ğ¾Ğ³Ñƒ Ğ¾Ğ±Ñ€Ğ°Ñ‚Ğ¸Ñ‚ÑŒÑÑ Ğº Ğ½ĞµĞ¹Ñ€Ğ¾ÑĞµÑ‚Ğ¸. "
    "ĞŸĞ¾Ğ¿Ñ€Ğ¾Ğ±ÑƒĞ¹ ÑÑ„Ğ¾Ñ€Ğ¼ÑƒĞ»Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ·Ğ°Ğ´Ğ°Ñ‡Ñƒ ĞµÑ‰Ñ‘ Ñ€Ğ°Ğ· Ğ¿Ğ¾Ğ¿Ñ€Ğ¾Ñ‰Ğµ Ğ¸Ğ»Ğ¸ Ğ¿Ğ¾Ğ·Ğ¶Ğµ ğŸ¦Š"
)

# -------------------------------------------------
# ĞŸÑ€Ğ¾Ğ¼Ğ¿Ñ‚Ñ‹
# -------------------------------------------------

PROMPT_CONTRACT = """
Ğ¢Ñ‹ â€” LegalFox, Ğ˜Ğ˜-Ğ¿Ğ¾Ğ¼Ğ¾Ñ‰Ğ½Ğ¸Ğº Ğ´Ğ»Ñ ÑÑ€Ğ¸ÑÑ‚Ğ¾Ğ². Ğ¢Ğ²Ğ¾Ñ Ğ·Ğ°Ğ´Ğ°Ñ‡Ğ° â€” Ğ½Ğ° Ğ¾ÑĞ½Ğ¾Ğ²Ğµ ÑÑ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ğ¾Ğ¹
Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ğ¸ Ğ¾Ñ‚ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»Ñ Ğ¿Ğ¾Ğ´Ğ³Ğ¾Ñ‚Ğ¾Ğ²Ğ¸Ñ‚ÑŒ Ğ§Ğ•Ğ ĞĞĞ’Ğ˜Ğš Ğ³Ñ€Ğ°Ğ¶Ğ´Ğ°Ğ½ÑĞºĞ¾-Ğ¿Ñ€Ğ°Ğ²Ğ¾Ğ²Ğ¾Ğ³Ğ¾ Ğ´Ğ¾Ğ³Ğ¾Ğ²Ğ¾Ñ€Ğ° Ğ² Ğ Ğ¤.

Ğ¤Ğ¾Ñ€Ğ¼Ğ°Ñ‚:
1) ĞšÑ€Ğ°Ñ‚ĞºĞ°Ñ Ğ²Ğ²Ğ¾Ğ´Ğ½Ğ°Ñ ÑÑ‚Ñ€Ğ¾ĞºĞ° (1 Ğ¿Ñ€ĞµĞ´Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ğµ, Ñ‡Ñ‚Ğ¾ Ğ·Ğ° Ğ´Ğ¾Ğ³Ğ¾Ğ²Ğ¾Ñ€).
2) ĞŸĞ¾Ğ»Ğ½Ñ‹Ğ¹ Ñ‚ĞµĞºÑÑ‚ Ğ´Ğ¾Ğ³Ğ¾Ğ²Ğ¾Ñ€Ğ° Ñ Ğ½ÑƒĞ¼ĞµÑ€Ğ°Ñ†Ğ¸ĞµĞ¹ Ñ€Ğ°Ğ·Ğ´ĞµĞ»Ğ¾Ğ² Ğ¸ Ğ¿ÑƒĞ½ĞºÑ‚Ğ¾Ğ².
3) Ğ¢ĞµĞºÑÑ‚ Ğ´Ğ¾Ğ»Ğ¶ĞµĞ½ Ğ±Ñ‹Ñ‚ÑŒ Ğ¿Ñ€Ğ¸Ğ³Ğ¾Ğ´ĞµĞ½ Ğ´Ğ»Ñ ĞºĞ¾Ğ¿Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ğ² Word/Google Docs.
4) ĞĞµ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞ¹ Markdown (**Ğ·Ğ²Ñ‘Ğ·Ğ´Ğ¾Ñ‡ĞºĞ¸**, #Ğ·Ğ°Ğ³Ğ¾Ğ»Ğ¾Ğ²ĞºĞ¸ Ğ¸ Ñ‚.Ğ¿.).

Ğ’ÑĞµĞ³Ğ´Ğ° ÑĞ¾Ğ±Ğ»ÑĞ´Ğ°Ğ¹ Ñ€Ğ¾ÑÑĞ¸Ğ¹ÑĞºĞ¾Ğµ Ğ¿Ñ€Ğ°Ğ²Ğ¾ (Ğ“Ğš Ğ Ğ¤). ĞŸĞ¸ÑˆĞ¸ Ğ½ĞµĞ¹Ñ‚Ñ€Ğ°Ğ»ÑŒĞ½Ñ‹Ğ¼ ÑÑ€Ğ¸Ğ´Ğ¸Ñ‡ĞµÑĞºĞ¸Ğ¼ ÑĞ·Ñ‹ĞºĞ¾Ğ¼,
Ğ±ĞµĞ· ÑˆÑƒÑ‚Ğ¾Ğº Ğ¸ Ğ²Ğ¾Ğ´Ñ‹.

Ğ”Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¿Ñ€Ğ¸Ñ…Ğ¾Ğ´ÑÑ‚ Ğ² Ğ²Ğ¸Ğ´Ğµ Ğ±Ğ»Ğ¾ĞºĞ¾Ğ²:
- Ğ¢Ğ¸Ğ¿ Ğ´Ğ¾Ğ³Ğ¾Ğ²Ğ¾Ñ€Ğ°;
- Ğ¡Ñ‚Ğ¾Ñ€Ğ¾Ğ½Ñ‹;
- ĞŸÑ€ĞµĞ´Ğ¼ĞµÑ‚;
- Ğ¡Ñ€Ğ¾ĞºĞ¸ Ğ¸ Ğ¾Ğ¿Ğ»Ğ°Ñ‚Ğ°;
- ĞÑĞ¾Ğ±Ñ‹Ğµ ÑƒÑĞ»Ğ¾Ğ²Ğ¸Ñ (ÑˆÑ‚Ñ€Ğ°Ñ„Ñ‹, Ğ¾Ñ‚Ğ²ĞµÑ‚ÑÑ‚Ğ²ĞµĞ½Ğ½Ğ¾ÑÑ‚ÑŒ, ĞºĞ¾Ğ½Ñ„Ğ¸Ğ´ĞµĞ½Ñ†Ğ¸Ğ°Ğ»ÑŒĞ½Ğ¾ÑÑ‚ÑŒ Ğ¸ Ñ‚.Ğ¿.).

Ğ¡Ğ¾Ğ±ĞµÑ€Ğ¸ Ğ¸Ğ· ÑÑ‚Ğ¾Ğ³Ğ¾ Ğ¾Ğ´Ğ¸Ğ½ ÑĞ²ÑĞ·Ğ½Ñ‹Ğ¹ Ñ‚ĞµĞºÑÑ‚ Ğ´Ğ¾Ğ³Ğ¾Ğ²Ğ¾Ñ€Ğ°.
"""

PROMPT_CLAIM = """
Ğ¢Ñ‹ â€” LegalFox, Ğ˜Ğ˜-Ğ¿Ğ¾Ğ¼Ğ¾Ñ‰Ğ½Ğ¸Ğº Ğ´Ğ»Ñ ÑÑ€Ğ¸ÑÑ‚Ğ¾Ğ². Ğ¢Ğ²Ğ¾Ñ Ğ·Ğ°Ğ´Ğ°Ñ‡Ğ° â€” ÑĞ¾ÑÑ‚Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ñ‡Ñ‘Ñ‚ĞºĞ¸Ğ¹ Ğ¸ ÑÑ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ğ¹
Ñ‡ĞµÑ€Ğ½Ğ¾Ğ²Ğ¸Ğº ĞŸĞ Ğ•Ğ¢Ğ•ĞĞ—Ğ˜Ğ˜/Ğ”ĞĞ¡Ğ£Ğ”Ğ•Ğ‘ĞĞĞ™ Ğ ĞĞ¡ĞŸĞĞ Ğ¯Ğ”Ğ˜Ğ¢Ğ•Ğ›Ğ¬ĞĞĞ™ ĞŸĞ˜Ğ¡Ğ¬ĞœĞ.

Ğ¤Ğ¾Ñ€Ğ¼Ğ°Ñ‚:
1) "Ğ¨Ğ°Ğ¿ĞºĞ°" (Ğ°Ğ´Ñ€ĞµÑĞ°Ñ‚, Ğ¾Ñ‚ ĞºĞ¾Ğ³Ğ¾, ĞºĞ¾Ğ½Ñ‚Ğ°ĞºÑ‚Ñ‹ Ğ±ĞµĞ· Ğ²Ñ‹Ğ´ÑƒĞ¼Ñ‹Ğ²Ğ°Ğ½Ğ¸Ñ Ğ˜ĞĞ Ğ¸ Ñ‚.Ğ¿.).
2) ĞĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ Ğ¾ÑĞ½Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ğ¸ Ğ´Ğ¾Ğ³Ğ¾Ğ²Ğ¾Ñ€Ğ°/Ğ¾Ñ‚Ğ½Ğ¾ÑˆĞµĞ½Ğ¸Ğ¹ ÑÑ‚Ğ¾Ñ€Ğ¾Ğ½.
3) ĞĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ Ğ½Ğ°Ñ€ÑƒÑˆĞµĞ½Ğ¸Ñ Ğ¸ Ğ¾Ğ±ÑÑ‚Ğ¾ÑÑ‚ĞµĞ»ÑŒÑÑ‚Ğ² (Ğ¿Ğ¾ ÑÑƒÑ‚Ğ¸ Ñ„Ğ°ĞºÑ‚Ñ‹).
4) Ğ¤Ğ¾Ñ€Ğ¼ÑƒĞ»Ğ¸Ñ€Ğ¾Ğ²ĞºĞ° Ñ‚Ñ€ĞµĞ±Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğ¹.
5) Ğ¡Ñ€Ğ¾Ğº Ğ¸ÑĞ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ¸Ñ Ğ¸ Ğ¿Ğ¾ÑĞ»ĞµĞ´ÑÑ‚Ğ²Ğ¸Ñ Ğ¿Ñ€Ğ¸ Ğ½ĞµĞ¸ÑĞ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ¸Ğ¸.
6) Ğ—Ğ°ĞºĞ»ÑÑ‡Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ğ°Ñ Ñ‡Ğ°ÑÑ‚ÑŒ (Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑÑŒ, Ğ´Ğ°Ñ‚Ğ° â€” Ğ¾ÑÑ‚Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ğ¿ÑƒÑÑ‚Ñ‹Ğ¼Ğ¸ ÑÑ‚Ñ€Ğ¾ĞºĞ°Ğ¼Ğ¸).

ĞŸĞ¸ÑˆĞ¸ ÑÑƒÑ…Ğ¸Ğ¼, Ğ´ĞµĞ»Ğ¾Ğ²Ñ‹Ğ¼ ÑĞ·Ñ‹ĞºĞ¾Ğ¼. ĞĞµ Ğ¿Ñ€Ğ¸Ğ´ÑƒĞ¼Ñ‹Ğ²Ğ°Ğ¹ Ğ½Ğ¾Ğ¼ĞµÑ€Ğ° ÑÑ‚Ğ°Ñ‚ĞµĞ¹, ĞµÑĞ»Ğ¸ Ğ¸Ñ… Ğ½ĞµÑ‚ Ğ² Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…,
Ğ½Ğ¾ Ğ¼Ğ¾Ğ¶ĞµÑˆÑŒ ÑÑÑ‹Ğ»Ğ°Ñ‚ÑŒÑÑ Ğ½Ğ° Ğ¾Ğ±Ñ‰Ğ¸Ğµ Ğ½Ğ¾Ñ€Ğ¼Ñ‹ Ğ“Ğš Ğ Ğ¤ (Ğ½Ğ°Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€, Ğ¾Ğ±ÑĞ·Ğ°Ñ‚ĞµĞ»ÑŒÑÑ‚Ğ²Ğ¾ Ğ¸ÑĞ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚ÑŒ Ğ² ÑÑ€Ğ¾Ğº).
ĞĞµ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞ¹ Markdown.
"""

PROMPT_CLAUSE = """
Ğ¢Ñ‹ â€” LegalFox, Ğ˜Ğ˜-Ğ°ÑÑĞ¸ÑÑ‚ĞµĞ½Ñ‚ Ğ´Ğ»Ñ ÑÑ€Ğ¸ÑÑ‚Ğ¾Ğ².

Ğ—Ğ°Ğ´Ğ°Ñ‡Ğ°: Ğ¿Ğ¾ Ğ¿Ñ€Ğ¸ÑĞ»Ğ°Ğ½Ğ½Ğ¾Ğ¼Ñƒ Ñ„Ñ€Ğ°Ğ³Ğ¼ĞµĞ½Ñ‚Ñƒ Ğ´Ğ¾Ğ³Ğ¾Ğ²Ğ¾Ñ€Ğ° (1â€“Ğ½ĞµÑĞºĞ¾Ğ»ÑŒĞºĞ¾ Ğ¿ÑƒĞ½ĞºÑ‚Ğ¾Ğ²) Ğ´Ğ°Ñ‚ÑŒ:
1) ĞºÑ€Ğ°Ñ‚ĞºĞ¾Ğµ Ñ‡ĞµĞ»Ğ¾Ğ²ĞµÑ‡ĞµÑĞºĞ¾Ğµ Ğ¿Ğ¾ÑÑĞ½ĞµĞ½Ğ¸Ğµ, Ñ‡Ñ‚Ğ¾ ÑÑ‚Ğ¾ ÑƒÑĞ»Ğ¾Ğ²Ğ¸Ğµ Ğ¾Ğ·Ğ½Ğ°Ñ‡Ğ°ĞµÑ‚;
2) ĞºĞ°ĞºĞ¸Ğµ Ñ€Ğ¸ÑĞºĞ¸ Ğ´Ğ»Ñ ĞºĞ»Ğ¸ĞµĞ½Ñ‚Ğ° Ğ¾Ğ½Ğ¾ Ğ½ĞµÑÑ‘Ñ‚;
3) Ğ¿Ñ€Ğ¸ Ğ½ĞµĞ¾Ğ±Ñ…Ğ¾Ğ´Ğ¸Ğ¼Ğ¾ÑÑ‚Ğ¸ â€” Ğ¿Ñ€ĞµĞ´Ğ»Ğ¾Ğ¶Ğ¸Ñ‚ÑŒ Ğ±Ğ¾Ğ»ĞµĞµ Ğ±ĞµĞ·Ğ¾Ğ¿Ğ°ÑĞ½ÑƒÑ Ñ„Ğ¾Ñ€Ğ¼ÑƒĞ»Ğ¸Ñ€Ğ¾Ğ²ĞºÑƒ.

Ğ¤Ğ¾Ñ€Ğ¼Ğ°Ñ‚ Ğ¾Ñ‚Ğ²ĞµÑ‚Ğ°:
1) "ĞšÑ€Ğ°Ñ‚ĞºĞ¸Ğ¹ ÑĞ¼Ñ‹ÑĞ»:" â€” 1â€“3 Ğ¿Ñ€ĞµĞ´Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ñ Ğ¿Ñ€Ğ¾ÑÑ‚Ñ‹Ğ¼ ÑĞ·Ñ‹ĞºĞ¾Ğ¼.
2) "Ğ Ğ¸ÑĞºĞ¸:" â€” 2â€“5 ĞºĞ¾Ñ€Ğ¾Ñ‚ĞºĞ¸Ñ… Ğ¿ÑƒĞ½ĞºÑ‚Ğ¾Ğ² Ñ‡ĞµÑ€ĞµĞ· Ğ½ÑƒĞ¼ĞµÑ€Ğ°Ñ†Ğ¸Ñ 1), 2), 3) ...
3) "ĞœĞ¾Ğ¶Ğ½Ğ¾ Ğ¿Ğ¾Ğ¿Ñ€Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ñ‚Ğ°Ğº:" â€” Ğ¿Ñ€ĞµĞ´Ğ»Ğ¾Ğ¶Ğ¸ Ğ¾Ğ´Ğ¸Ğ½ Ğ²Ğ°Ñ€Ğ¸Ğ°Ğ½Ñ‚ Ğ¿ĞµÑ€ĞµĞ¿Ğ¸ÑĞ°Ğ½Ğ½Ğ¾Ğ³Ğ¾ Ğ¿ÑƒĞ½ĞºÑ‚Ğ°.
ĞĞµ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞ¹ Markdown-Ñ€Ğ°Ğ·Ğ¼ĞµÑ‚ĞºÑƒ (*, #, Ğ¸ Ñ‚.Ğ¿.).
ĞŸĞ¸ÑˆĞ¸ Ñ ÑƒÑ‡Ñ‘Ñ‚Ğ¾Ğ¼ Ğ¿Ñ€Ğ°Ğ²Ğ° Ğ Ğ¤.
"""

# -------------------------------------------------
# ĞšĞ»Ğ¸ĞµĞ½Ñ‚ Groq
# -------------------------------------------------

client: Groq | None = None

if GROQ_API_KEY:
    try:
        client = Groq(api_key=GROQ_API_KEY)
        logger.info("Groq client Ğ¸Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½")
    except Exception:
        logger.exception("ĞĞµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ Ğ¸Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ Groq client")
else:
    logger.warning("GROQ_API_KEY Ğ½Ğµ Ğ·Ğ°Ğ´Ğ°Ğ½ â€” Ğ±ÑƒĞ´ĞµÑ‚ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ÑŒÑÑ Ñ‚Ğ¾Ğ»ÑŒĞºĞ¾ fallback")


async def call_groq(system_prompt: str, user_query: str) -> str:
    """
    Ğ’Ñ‹Ğ·Ğ¾Ğ² Groq, Ğ²Ğ¾Ğ·Ğ²Ñ€Ğ°Ñ‰Ğ°ĞµÑ‚ Ñ‚ĞµĞºÑÑ‚ Ğ¾Ñ‚Ğ²ĞµÑ‚Ğ° Ğ¸Ğ»Ğ¸ ĞºĞ¸Ğ´Ğ°ĞµÑ‚ Ğ¸ÑĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ğµ.
    """
    if client is None:
        raise RuntimeError("Groq client is not available")

    messages = [
        {"role": "system", "content": system_prompt},
        {"role": "user", "content": user_query.strip()},
    ]

    chat_completion = client.chat.completions.create(
        model=GROQ_MODEL,
        messages=messages,
        temperature=0.4,
        max_tokens=1400,
        top_p=1,
    )

    content = chat_completion.choices[0].message.content or ""
    return content.strip()


async def generate_reply(system_prompt: str, query: str, scenario: str) -> Dict[str, Any]:
    """
    ĞĞ±Ñ‰Ğ°Ñ Ğ¾Ğ±Ñ‘Ñ€Ñ‚ĞºĞ°: Ğ¿Ñ€Ğ¾Ğ±ÑƒĞµĞ¼ Groq, Ğ¿Ñ€Ğ¸ Ğ¾ÑˆĞ¸Ğ±ĞºĞµ â€” fallback.
    """
    safe_scenario = scenario or "contract"

    if not query or not query.strip():
        return {
            "reply_text": "ĞŸĞ¾ĞºĞ° Ğ½ĞµÑ‚ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…. ĞĞ°Ğ¿Ğ¸ÑˆĞ¸ Ñ‚ĞµĞºÑÑ‚/Ğ¾Ğ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ, Ñ ĞºĞ¾Ñ‚Ğ¾Ñ€Ñ‹Ğ¼ Ğ½ÑƒĞ¶Ğ½Ğ¾ Ğ¿Ğ¾Ğ¼Ğ¾Ñ‡ÑŒ.",
            "scenario": safe_scenario,
        }

    try:
        answer = await call_groq(system_prompt, query)
        logger.info("Ğ£ÑĞ¿ĞµÑˆĞ½Ñ‹Ğ¹ Ğ¾Ñ‚Ğ²ĞµÑ‚ Ğ¾Ñ‚ Groq Ğ´Ğ»Ñ ÑÑ†ĞµĞ½Ğ°Ñ€Ğ¸Ñ %s", safe_scenario)
        return {
            "reply_text": answer,
            "scenario": safe_scenario,
        }
    except Exception as e:
        logger.exception("Groq API error: %s", e)
        return {
            "reply_text": FALLBACK_TEXT,
            "scenario": safe_scenario,
        }


# -------------------------------------------------
# FastAPI
# -------------------------------------------------

app = FastAPI(
    title="LegalFox API (Groq, Railway)",
    description="Backend Ğ´Ğ»Ñ LegalFox â€” Ğ˜Ğ˜-Ğ¿Ğ¾Ğ¼Ğ¾Ñ‰Ğ½Ğ¸ĞºĞ° ÑÑ€Ğ¸ÑÑ‚Ğ°Ğ¼",
    version="0.2.0",
)


@app.post("/legalfox")
async def legalfox_endpoint(payload: Dict[str, Any] = Body(...)) -> Dict[str, Any]:
    """
    Ğ“Ğ»Ğ°Ğ²Ğ½Ğ°Ñ Ñ‚Ğ¾Ñ‡ĞºĞ°, ĞºÑƒĞ´Ğ° ÑˆĞ»Ñ‘Ñ‚ Ğ·Ğ°Ğ¿Ñ€Ğ¾Ñ BotHelp.
    ĞĞ¶Ğ¸Ğ´Ğ°ĞµĞ¼ Ğ¿Ğ¾Ğ»Ğµ 'scenario' Ğ¸ Ğ´Ğ°Ğ»ÑŒÑˆĞµ â€” Ñ€Ğ°Ğ·Ğ½Ñ‹Ğµ Ğ¿Ğ¾Ğ»Ñ Ğ² Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚Ğ¸ Ğ¾Ñ‚ Ğ²ĞµÑ‚ĞºĞ¸.
    """
    logger.info("Incoming payload keys: %s", list(payload.keys()))

    scenario = (
        payload.get("scenario")
        or payload.get("Ğ¡Ñ†ĞµĞ½Ğ°Ñ€Ğ¸Ğ¹")
        or "contract"
    )

    # ---------------------------------------------
    # Ğ’Ğ•Ğ¢ĞšĞ 1. Ğ§ĞµÑ€Ğ½Ğ¾Ğ²Ğ¸Ğº Ğ´Ğ¾Ğ³Ğ¾Ğ²Ğ¾Ñ€Ğ° (contract)
    # ---------------------------------------------
    if scenario == "contract":
        contract_type = payload.get("Ğ¢Ğ¸Ğ¿ Ğ´Ğ¾Ğ³Ğ¾Ğ²Ğ¾Ñ€Ğ°", "")
        parties = payload.get("Ğ¡Ñ‚Ğ¾Ñ€Ğ¾Ğ½Ñ‹", "")
        subject = payload.get("ĞŸÑ€ĞµĞ´Ğ¼ĞµÑ‚", "")
        terms = payload.get("Ğ¡Ñ€Ğ¾ĞºĞ¸ Ğ¸ Ğ¾Ğ¿Ğ»Ğ°Ñ‚Ğ°", "")
        special = payload.get("ĞÑĞ¾Ğ±Ñ‹Ğµ ÑƒÑĞ»Ğ¾Ğ²Ğ¸Ñ", "")

        user_text = (
            f"Ğ¢Ğ¸Ğ¿ Ğ´Ğ¾Ğ³Ğ¾Ğ²Ğ¾Ñ€Ğ°: {contract_type}\n"
            f"Ğ¡Ñ‚Ğ¾Ñ€Ğ¾Ğ½Ñ‹: {parties}\n"
            f"ĞŸÑ€ĞµĞ´Ğ¼ĞµÑ‚: {subject}\n"
            f"Ğ¡Ñ€Ğ¾ĞºĞ¸ Ğ¸ Ğ¾Ğ¿Ğ»Ğ°Ñ‚Ğ°: {terms}\n"
            f"ĞÑĞ¾Ğ±Ñ‹Ğµ ÑƒÑĞ»Ğ¾Ğ²Ğ¸Ñ: {special}"
        )

        system_prompt = PROMPT_CONTRACT

    # ---------------------------------------------
    # Ğ’Ğ•Ğ¢ĞšĞ 2. ĞŸÑ€ĞµÑ‚ĞµĞ½Ğ·Ğ¸Ñ / Ğ´Ğ¾ÑÑƒĞ´ĞµĞ±ĞºĞ° (claim)
    # ---------------------------------------------
    elif scenario == "claim":
        adresat = payload.get("ĞĞ´Ñ€ĞµÑĞ°Ñ‚", "")
        basis = payload.get("ĞÑĞ½Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ", "")
        facts = payload.get("ĞĞ°Ñ€ÑƒÑˆĞµĞ½Ğ¸Ğµ Ğ¸ Ğ¾Ğ±ÑÑ‚Ğ¾ÑÑ‚ĞµĞ»ÑŒÑÑ‚Ğ²Ğ°", "")
        demands = payload.get("Ğ¢Ñ€ĞµĞ±Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ", "")
        deadline = payload.get("Ğ¡Ñ€Ğ¾ĞºĞ¸ Ğ¸ÑĞ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ¸Ñ", "")
        contacts = payload.get("ĞšĞ¾Ğ½Ñ‚Ğ°ĞºÑ‚Ñ‹", "")

        user_text = (
            f"ĞĞ´Ñ€ĞµÑĞ°Ñ‚: {adresat}\n"
            f"ĞÑĞ½Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ: {basis}\n"
            f"ĞĞ°Ñ€ÑƒÑˆĞµĞ½Ğ¸Ğµ Ğ¸ Ğ¾Ğ±ÑÑ‚Ğ¾ÑÑ‚ĞµĞ»ÑŒÑÑ‚Ğ²Ğ°: {facts}\n"
            f"Ğ¢Ñ€ĞµĞ±Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ: {demands}\n"
            f"Ğ¡Ñ€Ğ¾Ğº Ğ¸ÑĞ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ¸Ñ: {deadline}\n"
            f"ĞšĞ¾Ğ½Ñ‚Ğ°ĞºÑ‚Ñ‹: {contacts}"
        )

        system_prompt = PROMPT_CLAIM

    # ---------------------------------------------
    # Ğ’Ğ•Ğ¢ĞšĞ 3. ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° Ğ¿ÑƒĞ½ĞºÑ‚Ğ° Ğ´Ğ¾Ğ³Ğ¾Ğ²Ğ¾Ñ€Ğ° (clause)
    # ---------------------------------------------
    elif scenario == "clause":
        clause_text = (
            payload.get("Ğ¢ĞµĞºÑÑ‚", "")
            or payload.get("text", "")
            or ""
        )
        user_text = clause_text
        system_prompt = PROMPT_CLAUSE

    # ---------------------------------------------
    # Fallback / Ğ½ĞµĞ¸Ğ·Ğ²ĞµÑÑ‚Ğ½Ñ‹Ğ¹ ÑÑ†ĞµĞ½Ğ°Ñ€Ğ¸Ğ¹
    # ---------------------------------------------
    else:
        user_text = payload.get("text", "") or ""
        system_prompt = PROMPT_CONTRACT  # Ñ‡Ñ‚Ğ¾-Ñ‚Ğ¾ Ğ¿Ğ¾ ÑƒĞ¼Ğ¾Ğ»Ñ‡Ğ°Ğ½Ğ¸Ñ
        scenario = "contract"

    # Ğ“ĞµĞ½ĞµÑ€Ğ¸Ñ€ÑƒĞµĞ¼ Ğ¾Ñ‚Ğ²ĞµÑ‚ Ğ˜Ğ˜
    result = await generate_reply(system_prompt, user_text, scenario)

    # -------------------------------------------------
    # Ğ”ĞĞ‘ĞĞ’Ğ›Ğ¯Ğ•Ğœ file_url Ğ”Ğ›Ğ¯ Ğ¡Ğ¦Ğ•ĞĞĞ Ğ˜Ğ¯ Ğ”ĞĞ“ĞĞ’ĞĞ Ğ
    # -------------------------------------------------
    if scenario == "contract":
        # TODO: Ğ·Ğ°Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ Ğ½Ğ° Ñ€ĞµĞ°Ğ»ÑŒĞ½Ñ‹Ğ¹ URL ÑƒĞ¶Ğµ Ğ³Ğ¾Ñ‚Ğ¾Ğ²Ğ¾Ğ³Ğ¾ Ñ„Ğ°Ğ¹Ğ»Ğ° (PDF/DOCX),
        # ĞºĞ¾Ñ‚Ğ¾Ñ€Ñ‹Ğ¹ Ñ‚Ñ‹ Ğ±ÑƒĞ´ĞµÑˆÑŒ Ğ³ĞµĞ½ĞµÑ€Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ¸ Ğ²Ñ‹ĞºĞ»Ğ°Ğ´Ñ‹Ğ²Ğ°Ñ‚ÑŒ ĞºÑƒĞ´Ğ°-Ñ‚Ğ¾.
        #
        # Ğ¡ĞµĞ¹Ñ‡Ğ°Ñ â€” Ğ¿Ñ€Ğ¾ÑÑ‚Ğ¾ Ñ‚ĞµÑÑ‚Ğ¾Ğ²Ñ‹Ğ¹ Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€. ĞœĞ¾Ğ¶Ğ½Ğ¾ Ğ¿Ğ¾ÑÑ‚Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ğ»ÑĞ±Ğ¾Ğ¹
        # ÑĞ²Ğ¾Ğ¹ Ñ„Ğ°Ğ¹Ğ» Ğ½Ğ° Google Drive/Dropbox Ñ Ğ¿Ñ€ÑĞ¼Ğ¾Ğ¹ ÑÑÑ‹Ğ»ĞºĞ¾Ğ¹.
        result["file_url"] = "https://example.com/test-contract.pdf"

    return result


@app.get("/")
async def root() -> Dict[str, str]:
    return {"status": "ok", "message": "LegalFox backend is running"}
